<!doctype html>
<html lang="vi" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Há»c tá»« vá»±ng - English Blossom AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.6s ease-out forwards; }
    .gradient-bg { background: linear-gradient(135deg, #fce7f3 0%, #ffffff 50%, #fff1f2 100%); }
    .gradient-text { background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .btn-pink { transition: all 0.3s ease; background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); }
    .btn-pink:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(236, 72, 153, 0.4); }
    .card-3d { perspective: 1000px; transition: transform 0.3s ease; }
    .card-3d:hover { transform: translateY(-5px); }
    .flashcard { position: relative; width: 100%; height: 300px; transform-style: preserve-3d; transition: transform 0.6s; }
    .flashcard.flipped { transform: rotateY(180deg); }
    .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 1.5rem; padding: 2rem; }
    .flashcard-back { transform: rotateY(180deg); }
    .word-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem; }
    .word-cell { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; font-weight: bold; background: white; border: 2px solid #fbcfe8; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; user-select: none; }
    .word-cell:hover { background: #fce7f3; transform: scale(1.1); }
    .word-cell.selected { background: #ec4899; color: white; border-color: #ec4899; }
    .word-cell.found { background: #86efac; color: #166534; border-color: #86efac; }
    .progress-bar { height: 8px; background: #fbcfe8; border-radius: 9999px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); transition: width 0.3s ease; }
    .hidden { display: none !important; }
    .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
    @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full w-full">
  <div id="app" class="w-full h-full overflow-auto gradient-bg">
   <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
     <div class="flex items-center"><span class="text-4xl mr-3">ğŸŒ¸</span>
      <div>
       <h1 id="pageTitle" class="text-2xl font-bold gradient-text">English Blossom AI</h1>
       <p class="text-sm text-gray-600">Há»c thÃ´ng minh - Lá»™ trÃ¬nh cÃ¡ nhÃ¢n hÃ³a</p>
      </div>
     </div><button onclick="showSection('menu')" class="btn-pink text-white px-6 py-2 rounded-xl font-semibold"> ğŸ“š Menu </button>
    <button onclick="toggleAICamera()" class="ml-4 bg-gray-800 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-gray-700 flex items-center gap-2">
    ğŸ‘ï¸ AI Camera: <span id="aiStatus">OFF</span>
</button>
     </div>
   </header>

   <main class="max-w-7xl mx-auto px-6 py-8">
    <section id="menu" class="fade-in">
     <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="card-3d bg-white rounded-2xl p-6 shadow-lg cursor-pointer" onclick="showSection('assessment')">
       <div class="text-5xl mb-4 text-center">ğŸ¯</div>
       <h3 class="text-xl font-bold text-center mb-2 gradient-text">Test Äáº§u VÃ o</h3>
       <p class="text-gray-600 text-center text-sm">AI Adaptive Test (A1-C1)</p>
      </div>
      <div class="card-3d bg-white rounded-2xl p-6 shadow-lg cursor-pointer" onclick="checkDataAndShow('learning')">
       <div class="text-5xl mb-4 text-center">ğŸ“–</div>
       <h3 class="text-xl font-bold text-center mb-2 gradient-text">Há»c Tá»« Má»›i</h3>
       <p class="text-gray-600 text-center text-sm">Lá»™ trÃ¬nh AI táº¡o riÃªng cho báº¡n</p>
      </div>
      <div class="card-3d bg-white rounded-2xl p-6 shadow-lg cursor-pointer" onclick="checkDataAndShow('games')">
       <div class="text-5xl mb-4 text-center">ğŸ®</div>
       <h3 class="text-xl font-bold text-center mb-2 gradient-text">Game Ã”n Táº­p</h3>
       <p class="text-gray-600 text-center text-sm">Matching, Word Hunt, Speed</p>
      </div>
      <div class="card-3d bg-white rounded-2xl p-6 shadow-lg cursor-pointer" onclick="initTestSection()">
       <div class="text-5xl mb-4 text-center">âœ…</div>
       <h3 class="text-xl font-bold text-center mb-2 gradient-text">Kiá»ƒm Tra</h3>
       <p class="text-gray-600 text-center text-sm">CÃ¢u há»i tÃ¬nh huá»‘ng (Context)</p>
      </div>
     </div>
     <div class="mt-8 text-center text-gray-500 italic text-sm">
        * LÆ°u Ã½: Há»‡ thá»‘ng sá»­ dá»¥ng AI thá»i gian thá»±c, vui lÃ²ng Ä‘á»£i vÃ i giÃ¢y khi táº¡o ná»™i dung.
     </div>
    </section>

    <section id="assessment" class="hidden">
     <div class="bg-white rounded-2xl p-8 shadow-lg max-w-3xl mx-auto">
      <h2 class="text-3xl font-bold gradient-text mb-6 text-center">ğŸ¯ ÄÃ¡nh giÃ¡ nÄƒng lá»±c thá»±c táº¿</h2>
      
      <div id="assessmentIntro" class="text-center">
          <p class="mb-6 text-gray-600">AI sáº½ Ä‘Æ°a ra cÃ¡c cÃ¢u há»i Ä‘á»ƒ xÃ¡c Ä‘á»‹nh trÃ¬nh Ä‘á»™ cá»§a báº¡n (A1 Ä‘áº¿n C1).<br>Há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng Ä‘iá»u chá»‰nh Ä‘á»™ khÃ³ dá»±a trÃªn cÃ¢u tráº£ lá»i cá»§a báº¡n.</p>
          <button onclick="startPlacement()" class="btn-pink text-white px-8 py-3 rounded-xl font-semibold">Báº¯t Ä‘áº§u Test</button>
      </div>

      <div id="assessmentLoading" class="hidden text-center py-10">
          <div class="text-5xl mb-4 animate-bounce">ğŸ¤–</div>
          <p class="text-lg font-semibold text-pink-600">AI Ä‘ang soáº¡n cÃ¢u há»i má»›i phÃ¹ há»£p vá»›i báº¡n<span class="loading-dots"></span></p>
      </div>

      <div id="assessmentQuiz" class="hidden space-y-6">
       <div class="mb-4">
        <div class="flex justify-between text-sm text-gray-600 mb-2">
            <span>Äá»™ khÃ³ hiá»‡n táº¡i: <span id="currentDiffDisplay" class="font-bold text-pink-500">A1</span></span> 
            <span id="assessmentScore">Tiáº¿n Ä‘á»™: 0/10</span>
        </div>
        <div class="progress-bar">
         <div id="assessmentProgress" class="progress-fill" style="width: 0%"></div>
        </div>
       </div>
       <div id="assessmentQuestion" class="bg-pink-50 p-6 rounded-xl min-h-[200px]">
        </div>
      </div>
      
      <div id="assessmentResult" class="hidden">
        <div class="text-center">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h3 class="text-2xl font-bold gradient-text mb-4">Káº¿t quáº£ Ä‘Ã¡nh giÃ¡</h3>
            <div class="bg-pink-50 p-6 rounded-xl mb-6">
                <p class="text-lg mb-2">TrÃ¬nh Ä‘á»™ xÃ¡c Ä‘á»‹nh: <span id="finalLevel" class="font-bold text-pink-600 text-2xl">Beginner</span></p>
                <p class="text-gray-600 mt-2 italic" id="levelDescription">...</p>
            </div>
        </div>
        
        <div id="preferenceForm" class="bg-white border-2 border-pink-100 p-6 rounded-xl mb-6">
            <h4 class="font-bold text-lg mb-4 text-pink-600 border-b pb-2">ğŸ“‹ Thiáº¿t láº­p lá»™ trÃ¬nh há»c táº­p chi tiáº¿t</h4>
            
            <div class="grid md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Chá»§ Ä‘á» quan tÃ¢m nháº¥t:</label>
                    <select id="topicSelect" class="w-full p-2 border border-pink-200 rounded-lg focus:border-pink-500 outline-none">
                        <option value="Daily Communication">Giao tiáº¿p hÃ ng ngÃ y (Daily Life)</option>
                        <option value="Business English">Tiáº¿ng Anh cÃ´ng sá»Ÿ & Há»p hÃ nh</option>
                        <option value="Travel & Adventure">Du lá»‹ch & KhÃ¡m phÃ¡ vÄƒn hÃ³a</option>
                        <option value="Technology & IT">CÃ´ng nghá»‡ & Ká»¹ thuáº­t (IT)</option>
                        <option value="IELTS Academic">Tá»« vá»±ng há»c thuáº­t (IELTS/TOEIC)</option>
                        <option value="Medical English">Tiáº¿ng Anh Y khoa</option>
                        <option value="Marketing & Sales">Marketing & BÃ¡n hÃ ng</option>
                    </select>
                </div>
                <div>
                     <label class="block text-gray-700 text-sm font-bold mb-2">Phong cÃ¡ch há»c:</label>
                     <select id="styleSelect" class="w-full p-2 border border-pink-200 rounded-lg focus:border-pink-500 outline-none">
                        <option value="formal">Trang trá»ng (Formal)</option>
                        <option value="casual">ThÃ¢n máº­t, tá»± nhiÃªn (Casual/Slang)</option>
                        <option value="idiomatic">Táº­p trung thÃ nh ngá»¯ (Idioms)</option>
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Má»¥c tiÃªu cá»¥ thá»ƒ (AI sáº½ tá»‘i Æ°u vÃ­ dá»¥ theo Ä‘Ã¢y):</label>
                <input type="text" id="userGoal" class="w-full p-2 border border-pink-200 rounded-lg" placeholder="VD: Viáº¿t email cho khÃ¡ch hÃ ng, phá»ng váº¥n xin viá»‡c..." value="Giao tiáº¿p tá»± tin">
            </div>
        </div>

        <button id="btnGenerate" onclick="submitPreferences()" class="w-full py-3 btn-pink text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all">
    âœ¨ AI Táº¡o lá»™ trÃ¬nh ngay
</button>
      </div>
     </div>
    </section>

    <section id="learning" class="hidden">
     <div class="bg-white rounded-2xl p-8 shadow-lg max-w-3xl mx-auto">
      <h2 class="text-3xl font-bold gradient-text mb-6 text-center">ğŸ“– Há»c tá»« má»›i (AI Generated)</h2>
      

<div class="mb-4 flex justify-center items-center gap-2">
    <select id="batchSelect" onchange="changeBatch()" class="flex-1 p-3 border-2 border-pink-300 rounded-xl bg-white text-gray-700 font-semibold shadow-sm focus:outline-none focus:border-pink-500 transition-all max-w-sm">
        <option value="latest">â­ Bá»™ tá»« má»›i nháº¥t</option>
        <option disabled>Äang táº£i danh sÃ¡ch...</option>
    </select>
    
    <button onclick="generateNewBatch(this)" class="bg-pink-100 text-pink-600 px-4 py-3 rounded-xl font-bold hover:bg-pink-200 transition-all whitespace-nowrap border-2 border-pink-200 shadow-sm">
        + Bá»™ má»›i
    </button>
</div>
      <div class="mb-6">
       <div class="flex justify-between text-sm text-gray-600 mb-2"><span>Tá»« <span id="learningCurrent">1</span>/<span id="learningTotal">20</span></span> <span id="learnedCount">ÄÃ£ há»c: 0</span>
       </div>
       <div class="progress-bar">
        <div id="learningProgress" class="progress-fill" style="width: 5%"></div>
       </div>
      </div>
      <div class="flashcard cursor-pointer" id="flashcard" onclick="flipCard()">
       <div class="flashcard-face flashcard-front bg-gradient-to-br from-pink-100 to-pink-50 shadow-xl border border-pink-200">
        <div class="text-center w-full px-4">
         <p class="text-sm text-pink-600 font-bold mb-4 uppercase tracking-widest">Vocabulary</p>
         <h3 id="wordFront" class="text-5xl font-extrabold text-gray-800 mb-2">Loading...</h3>
         <button onclick="playAudio(event)" class="mt-3 bg-white border border-pink-200 text-pink-600 px-4 py-2 rounded-full font-bold hover:bg-pink-50 hover:shadow-md transition-all flex items-center justify-center mx-auto gap-2">
    ğŸ”Š Nghe phÃ¡t Ã¢m
</button>
         <p id="wordType" class="text-lg text-pink-500 italic font-serif mb-4">...</p>
         <p class="text-sm text-gray-400 mt-8">Nháº¥n Ä‘á»ƒ xem nghÄ©a</p>
        </div>
       </div>
       <div class="flashcard-face flashcard-back bg-gradient-to-br from-rose-100 to-rose-50 shadow-xl border border-rose-200">
        <div class="text-center w-full px-4">
         <p class="text-sm text-rose-600 font-bold mb-4 uppercase tracking-widest">Meaning & Context</p>
         <h3 id="wordBack" class="text-3xl font-bold text-gray-800 mb-4">...</h3>
         <div class="bg-white/60 p-4 rounded-xl text-left inline-block shadow-sm">
             <p class="text-lg text-gray-700 italic font-medium" id="wordExample">"..."</p>
         </div>
         <p id="wordNote" class="text-sm text-gray-500 mt-4"></p>
        </div>
       </div>
      </div>
      <div class="flex gap-4 mt-8"><button onclick="previousWord()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-colors"> â† TrÆ°á»›c </button> <button onclick="markAsLearned()" class="flex-1 bg-green-500 text-white py-3 rounded-xl font-semibold hover:bg-green-600 transition-colors"> âœ“ ÄÃ£ nhá»› </button> <button onclick="nextWord()" class="flex-1 btn-pink text-white py-3 rounded-xl font-semibold"> Tiáº¿p â†’ </button>
      </div>
     </div>
    </section>
<section id="games" class="hidden">
     <div class="bg-white rounded-2xl p-8 shadow-lg max-w-5xl mx-auto">
      <h2 class="text-3xl font-bold gradient-text mb-6 text-center">ğŸ® Game Ã´n táº­p</h2>
      
      <div id="gameMenu" class="grid md:grid-cols-3 gap-6 mb-8">
        <button onclick="playMatching()" class="card-3d bg-gradient-to-br from-pink-50 to-white p-6 rounded-xl border-2 border-pink-200 cursor-pointer hover:shadow-xl transition-all">
            <div class="text-4xl mb-3 text-center">ğŸ´</div>
            <h3 class="font-bold text-lg text-center mb-2 text-pink-600">Ná»‘i Tá»« (Matching)</h3>
            <p class="text-sm text-gray-600 text-center">GhÃ©p tá»« vá»±ng vá»›i nghÄ©a</p>
        </button> 
        <button onclick="playWordHunt()" class="card-3d bg-gradient-to-br from-green-50 to-white p-6 rounded-xl border-2 border-green-200 cursor-pointer hover:shadow-xl transition-all">
            <div class="text-4xl mb-3 text-center">ğŸ”</div>
            <h3 class="font-bold text-lg text-center mb-2 text-green-600">TÃ¬m Tá»« (Word Hunt)</h3>
            <p class="text-sm text-gray-600 text-center">TÃ¬m tá»« áº©n trong Ã´ chá»¯</p>
        </button> 
        <button onclick="playSpeedMatch()" class="card-3d bg-gradient-to-br from-blue-50 to-white p-6 rounded-xl border-2 border-blue-200 cursor-pointer hover:shadow-xl transition-all">
            <div class="text-4xl mb-3 text-center">âš¡</div>
            <h3 class="font-bold text-lg text-center mb-2 text-blue-600">Pháº£n Xáº¡ (Speed)</h3>
            <p class="text-sm text-gray-600 text-center">ÄÃºng/Sai trong 3 giÃ¢y</p>
        </button>
      </div>

      <div id="gamePlayArea"></div>
     </div>
    </section>

<section id="test" class="hidden">
     <div class="bg-white rounded-2xl p-8 shadow-lg max-w-4xl mx-auto">
      <div class="text-center mb-8">
          <h2 class="text-3xl font-bold gradient-text mb-2">âœ… Kiá»ƒm tra nÄƒng lá»±c</h2>
          <p class="text-gray-500">20 cÃ¢u há»i tráº¯c nghiá»‡m â€¢ Giáº£i thÃ­ch chi tiáº¿t</p>
      </div>
      
      <div id="testLoading" class="hidden text-center py-12">
          <div class="text-6xl mb-4 animate-bounce">ğŸ“</div>
          <h3 class="text-xl font-bold text-pink-600 mb-2">AI Ä‘ang soáº¡n Ä‘á» thi...</h3>
          <p class="text-gray-500">Äang phÃ¢n tÃ­ch bá»™ tá»« vá»±ng vÃ  táº¡o tÃ¬nh huá»‘ng (khoáº£ng 10-15s)</p>
      </div>

      <div id="testQuiz" class="hidden">
       <div class="sticky top-0 bg-white z-10 py-4 border-b mb-6 shadow-sm">
        <div class="flex justify-between items-center mb-2">
            <span class="font-bold text-gray-700">Tiáº¿n Ä‘á»™ lÃ m bÃ i</span>
            <span id="testScoreDisplay" class="font-bold text-pink-600 hidden">0/20</span>
        </div>
        <div class="h-3 bg-gray-100 rounded-full overflow-hidden">
         <div id="testProgress" class="h-full bg-pink-500 transition-all duration-500" style="width: 0%"></div>
        </div>
       </div>

       <div id="testQuestions" class="space-y-8"></div>
       
       <div class="mt-8 pt-6 border-t">
           <button id="testSubmit" onclick="submitTest()" class="w-full btn-pink text-white py-4 rounded-2xl font-bold text-xl shadow-lg hover:shadow-xl hover:scale-[1.01] transition-all"> 
               ğŸš€ Ná»˜P BÃ€I & XEM GIáº¢I THÃCH 
           </button>
           <button id="testRetry" onclick="initTestSection()" class="hidden w-full bg-gray-200 text-gray-700 py-4 rounded-2xl font-bold text-xl hover:bg-gray-300 transition-all"> 
               ğŸ”„ LÃ m Ä‘á» khÃ¡c 
           </button>
       </div>
      </div>

      <div id="testResult" class="hidden text-center py-8">
       <div class="text-7xl mb-4">ğŸ†</div>
       <h3 class="text-3xl font-bold gradient-text mb-4">Káº¿t quáº£ cá»§a báº¡n</h3>
       <div class="bg-pink-50 p-8 rounded-2xl border-2 border-pink-100 inline-block mb-8">
        <p class="text-lg text-gray-600 mb-2">Tá»•ng Ä‘iá»ƒm</p>
        <p class="text-5xl font-extrabold text-pink-600"><span id="testFinalScore">0</span><span class="text-2xl text-gray-400">/20</span></p>
       </div>
       <p id="testFeedback" class="text-xl text-gray-700 font-medium italic">...</p>
      </div>
     </div>
    </section>
   </main>
  </div>

<script>
    const API_BASE = "/api";
    let token = localStorage.getItem("token");
    let currentBatchId = 'latest'; 

    function getHeaders() {
        const t = localStorage.getItem("token");
        const headers = { "Content-Type": "application/json" };
        if (t) headers.Authorization = `Bearer ${t}`;
        return headers;
    }

// --- HÃ€M ÄIá»€U HÆ¯á»šNG (Bá»Š THIáº¾U) ---
    function showSection(id) {
        // áº¨n táº¥t cáº£ cÃ¡c section
        document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
        
        // Hiá»‡n section Ä‘Æ°á»£c chá»n
        const el = document.getElementById(id);
        if(el) {
            el.classList.remove('hidden');
        } else {
            console.error(`KhÃ´ng tÃ¬m tháº¥y section cÃ³ id="${id}"`);
        }
    }
// --- HÃ€M ÄIá»€U HÆ¯á»šNG ---
    function showSection(id) {
        // áº¨n táº¥t cáº£ cÃ¡c section
        document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
        
        // Hiá»‡n section Ä‘Æ°á»£c chá»n
        const el = document.getElementById(id);
        if(el) {
            el.classList.remove('hidden');
        } else {
            console.error(`KhÃ´ng tÃ¬m tháº¥y section cÃ³ id="${id}"`);
        }
    }

    // [Bá»” SUNG] HÃ m nÃ y Ä‘ang bá»‹ thiáº¿u gÃ¢y ra lá»—i
    function checkDataAndShow(sectionId) {
        showSection(sectionId);
        
        // Náº¿u báº¥m vÃ o Há»c tá»« thÃ¬ gá»i hÃ m khá»Ÿi táº¡o há»c
        if(sectionId === 'learning') {
            initLearning(); // Máº·c Ä‘á»‹nh load bá»™ má»›i nháº¥t hoáº·c bá»™ Ä‘ang chá»n
        }
        
        // Náº¿u báº¥m vÃ o Game thÃ¬ gá»i hÃ m khá»Ÿi táº¡o game
        if(sectionId === 'games') {
            initGames();
        }
    }
    
    // State quáº£n lÃ½ dá»¯ liá»‡u
    let vocabList = [];
    let vocabIndex = 0;
    let currentTestQuestions = [];
    let currentTestQs = [];
    let aiCamera = null;
    let activeTestIndex = 0;
    let hardWords = new Set();

    async function ensureTestAICamera() {
        const statusEl = document.getElementById('aiStatus');
        const container = document.getElementById('aiCameraContainer');

        if (!aiCamera) {
            aiCamera = new AICamera('aiVideo', (state, emotion, score) => {
                if (state === 'struggling') registerStruggle(emotion, score);
            });
        }

        if (!aiCamera.isRunning) {
            await aiCamera.start();
            if (statusEl) statusEl.innerText = "ON";
            if (container) container.classList.remove('hidden');
        }
    }

    function toggleAICamera() {
        const statusEl = document.getElementById('aiStatus');
        const container = document.getElementById('aiCameraContainer');

        if (!aiCamera) {
            aiCamera = new AICamera('aiVideo', (state, emotion, score) => {
                if (state === 'struggling') registerStruggle(emotion, score);
            });
        }

        if (aiCamera.isRunning) {
            aiCamera.stop();
            if (statusEl) statusEl.innerText = "OFF";
            if (container) container.classList.add('hidden');
        } else {
            aiCamera.start();
            if (statusEl) statusEl.innerText = "ON";
            if (container) container.classList.remove('hidden');
        }
    }

    function setActiveTestIndex(i) {
        activeTestIndex = i;
        if (aiCamera?.resetStruggle) aiCamera.resetStruggle();
    }

    function getHardWordFromQuestion(q) {
        return q?.targetWord || q?.word || q?.correctAnswer || null;
    }

    function registerStruggle(emotion, score) {
        const q = currentTestQs[activeTestIndex];
        const hardWord = getHardWordFromQuestion(q);
        if (!hardWord) return;

        hardWords.add(hardWord);
        const card = document.getElementById(`q-card-${activeTestIndex}`);
        if (card) card.style.border = "2px solid orange";

        console.log(`ğŸ“ ÄÃ£ ghi láº¡i tá»« khÃ³: ${hardWord} (Do biá»ƒu hiá»‡n ${emotion}, ${score?.toFixed?.(2) ?? score})`);
    }

    async function sendHardWords(reason = "test-submit") {
        if (!hardWords.size) return;

        try {
            const res = await fetch(`${API_BASE}/vocab/hard-words`, {
                method: "POST",
                headers: getHeaders(),
                body: JSON.stringify({
                    batchId: currentBatchId,
                    hardWords: Array.from(hardWords),
                    reason
                })
            });
            if (res.ok) hardWords.clear();
        } catch (e) {
            console.error("Lá»—i gá»­i hardWords:", e);
        }
    }

    // --- MAIN FLOW (LUá»’NG CHÃNH) ---
    window.onload = async function() {
        if (!token) { window.location.href = 'trangdangnhap.html'; return; }
        
        try {
            // Kiá»ƒm tra tráº¡ng thÃ¡i User xem Ä‘ang á»Ÿ bÆ°á»›c nÃ o
            const res = await fetch(`${API_BASE}/placement/status`, { headers: getHeaders() });
            const status = await res.json();
            
            if (!status.hasFinishedTest) {
                // 1. ChÆ°a Test -> VÃ o lÃ m Placement Test
                showSection('assessment');
            } else if (!status.hasProfile) {
                // 2. Test rá»“i nhÆ°ng chÆ°a Ä‘iá»n Form -> Hiá»‡n Form
                showSection('assessment');
                document.getElementById('assessmentIntro').classList.add('hidden');
                document.getElementById('assessmentResult').classList.remove('hidden');
                document.getElementById('preferenceForm').classList.remove('hidden');
                if(status.level) document.getElementById('finalLevel').innerText = status.level;
            } else {
                // 3. Xong háº¿t -> VÃ o Menu chÃ­nh
                showSection('menu');
                loadBatches(); // Load danh sÃ¡ch cÃ¡c bá»™ tá»« Ä‘Ã£ há»c
            }
        } catch(e) { console.error("Lá»—i táº£i tráº¡ng thÃ¡i:", e); }
    };

    // --- 1. PLACEMENT TEST (30 CÃ‚U) ---
    let assessmentId = null;

    async function readJsonSafe(res) {
        const text = await res.text();
        if (!text) return null;
        try {
            return JSON.parse(text);
        } catch {
            return { message: text };
        }
    }

    function showPlacementError(message, details) {
        const el = document.getElementById('assessmentQuestion');
        if (!el) return;
        const extra = details ? `<pre class="mt-3 text-xs bg-white p-3 rounded-lg overflow-auto">${String(details)}</pre>` : "";
        el.innerHTML = `
            <div class="p-4 border-2 border-red-200 bg-red-50 rounded-xl">
                <div class="font-semibold text-red-700">${message}</div>
                ${extra}
            </div>
        `;
    }

    async function startPlacement() {
        try {
            document.getElementById('assessmentIntro').classList.add('hidden');
            document.getElementById('assessmentQuiz').classList.remove('hidden');

            showPlacementError("Äang táº£i cÃ¢u há»i...", "");

            const res = await fetch(`${API_BASE}/placement/start`, { method: "POST", headers: getHeaders() });
            const data = await readJsonSafe(res);

            if (!res.ok) {
                const msg = (data && data.message) ? data.message : "KhÃ´ng thá»ƒ báº¯t Ä‘áº§u placement test";
                showPlacementError(msg, `HTTP ${res.status}`);
                alert(msg);
                return;
            }

            if (!data || !data.assessmentId || !data.question) {
                showPlacementError("Server tráº£ vá» dá»¯ liá»‡u khÃ´ng há»£p lá»‡.", JSON.stringify(data, null, 2));
                return;
            }

            assessmentId = data.assessmentId;
            renderQuestion(data.question);
        } catch (e) {
            console.error("startPlacement error:", e);
            showPlacementError("Lá»—i khi táº£i cÃ¢u há»i. Má»Ÿ Console Ä‘á»ƒ xem chi tiáº¿t.", e && e.message ? e.message : String(e));
            alert("Lá»—i khi táº£i cÃ¢u há»i.");
        }
    }

    function renderQuestion(q) {
        try {
            if (!q || typeof q !== 'object') {
                showPlacementError("CÃ¢u há»i khÃ´ng há»£p lá»‡.", JSON.stringify(q, null, 2));
                return;
            }

            const content = (q.content ?? q.question ?? '').toString();
            const options = Array.isArray(q.options) ? q.options.map(o => String(o)) : [];
            if (!content) {
                showPlacementError("Thiáº¿u ná»™i dung cÃ¢u há»i.", JSON.stringify(q, null, 2));
                return;
            }

            const questionEl = document.getElementById('assessmentQuestion');
            questionEl.innerHTML = `
                <h3 class="text-xl font-bold mb-6 text-gray-800">${content}</h3>
                <div class="grid gap-3" id="assessmentOptions"></div>
            `;

            const optionsEl = document.getElementById('assessmentOptions');
            if (!options.length) {
                optionsEl.innerHTML = `<div class="text-sm text-gray-600">(KhÃ´ng cÃ³ Ä‘Ã¡p Ã¡n lá»±a chá»n)</div>`;
            } else {
                optionsEl.innerHTML = options.map((opt, idx) => `
                    <button data-ans-index="${idx}" 
                        class="p-4 border-2 border-gray-100 rounded-xl hover:border-pink-500 hover:bg-pink-50 text-left transition-all font-medium text-gray-700">
                        ${opt}
                    </button>
                `).join('');

                optionsEl.querySelectorAll('button[data-ans-index]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const i = Number(btn.getAttribute('data-ans-index'));
                        submitAns(options[i]);
                    });
                });
            }

            const current = Number(q.current) || 1;
            const total = Number(q.total) || 30;
            document.getElementById('assessmentScore').innerText = `CÃ¢u ${current}/${total}`;
            document.getElementById('assessmentProgress').style.width = `${Math.min(100, (current / total) * 100)}%`;
        } catch (e) {
            console.error("renderQuestion error:", e);
            showPlacementError("Lá»—i render cÃ¢u há»i.", e && e.message ? e.message : String(e));
        }
    }

    async function submitAns(ans) {
        try {
            const res = await fetch(`${API_BASE}/placement/next`, {
                method: "POST",
                headers: getHeaders(),
                body: JSON.stringify({ assessmentId, answer: ans })
            });

            const data = await readJsonSafe(res);

            if (!res.ok) {
                const msg = (data && data.message) ? data.message : "KhÃ´ng thá»ƒ láº¥y cÃ¢u há»i tiáº¿p theo";
                showPlacementError(msg, `HTTP ${res.status}`);
                alert(msg);
                return;
            }

            if (data && data.done) {
                // HoÃ n thÃ nh Test -> Hiá»‡n káº¿t quáº£ & Form
                document.getElementById('assessmentQuiz').classList.add('hidden');
                document.getElementById('assessmentResult').classList.remove('hidden');
                document.getElementById('finalLevel').innerText = data.finalLevel;
                document.getElementById('preferenceForm').classList.remove('hidden');
            } else if (data && data.question) {
                renderQuestion(data.question);
            } else {
                showPlacementError("Server tráº£ vá» dá»¯ liá»‡u khÃ´ng há»£p lá»‡.", JSON.stringify(data, null, 2));
            }
        } catch (e) {
            console.error("submitAns error:", e);
            showPlacementError("Lá»—i khi láº¥y cÃ¢u há»i tiáº¿p theo.", e && e.message ? e.message : String(e));
            alert("Lá»—i khi láº¥y cÃ¢u há»i tiáº¿p theo.");
        }
    }

    // --- 2. ONBOARDING (FORM -> Táº O BATCH 1) ---
    async function submitPreferences() {
        // Sá»¬A DÃ’NG NÃ€Y: Gá»i Ä‘Ãºng ID cá»§a nÃºt vá»«a Ä‘áº·t
        const btn = document.getElementById('btnGenerate'); 
        
        // ThÃªm kiá»ƒm tra Ä‘á»ƒ trÃ¡nh lá»—i náº¿u khÃ´ng tÃ¬m tháº¥y nÃºt
        if (btn) {
            btn.innerText = "â³ AI Ä‘ang táº¡o lá»™ trÃ¬nh & tá»« vá»±ng...";
            btn.disabled = true;
        }

        // Láº¥y dá»¯ liá»‡u tá»« Form
        const topicSelect = document.getElementById('topicSelect');
        const interests = topicSelect ? Array.from(topicSelect.selectedOptions).map(o => o.value) : ["General"];
        
        const goalInput = document.querySelector('input[name="goal"]:checked');
        const goal = goalInput ? goalInput.value : "Communication";
        
        try {
            const res = await fetch(`${API_BASE}/onboarding/survey`, {
                method: "POST", headers: getHeaders(),
                body: JSON.stringify({ interests: [interests[0] || "General"], goal })
            });
            
            const data = await res.json();

            if(res.ok) {
                alert(`ThÃ nh cÃ´ng! ÄÃ£ táº¡o bá»™ tá»« vá»±ng má»›i (${data.count} tá»«).`);
                window.location.reload(); // Reload Ä‘á»ƒ vÃ o tháº³ng Menu
            } else {
                alert("Lá»—i: " + (data.message || "KhÃ´ng thá»ƒ lÆ°u form"));
                if(btn) btn.disabled = false;
            }
        } catch(e) { 
            console.error(e);
            alert("Lá»—i káº¿t ná»‘i tá»›i Server."); 
            if(btn) btn.disabled = false; 
        }
    }

    // --- 3. Há»ŒC Tá»ª Vá»°NG (LEARNING) ---
    // 1. Cáº­p nháº­t hÃ m loadBatches (Äá»ƒ nÃ³ hiá»‡n danh sÃ¡ch vÃ o menu)
    async function loadBatches() {
        try {
            const res = await fetch(`${API_BASE}/vocab/batches`, { headers: getHeaders() });
            const batches = await res.json();
            
            const select = document.getElementById('batchSelect');
            if(select && batches.length > 0) {
                // Render danh sÃ¡ch bá»™ tá»« vÃ o tháº» select
                select.innerHTML = `<option value="latest">â­ Bá»™ tá»« má»›i nháº¥t</option>` + 
                    batches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
                
                // Giá»¯ tráº¡ng thÃ¡i bá»™ Ä‘ang chá»n
                if(currentBatchId) select.value = currentBatchId;
            }
        } catch(e) { console.error("Lá»—i load batches:", e); }
    }

    // 2. ThÃªm hÃ m changeBatch (HÃ m bá»‹ thiáº¿u gÃ¢y ra lá»—i)
    function changeBatch() {
        const select = document.getElementById('batchSelect');
        if(select) {
            // Láº¥y ID bá»™ tá»« vá»«a chá»n vÃ  gá»i hÃ m há»c láº¡i
            initLearning(select.value);
        }
    }

async function initLearning(batchId = 'latest') {
    currentBatchId = batchId;
    showSection('learning');
    
    // Reset giao diá»‡n flashcard
    document.getElementById('flashcard').classList.remove('hidden', 'flipped');
    
    try {
        // Táº£i danh sÃ¡ch bá»™ tá»« náº¿u chÆ°a cÃ³ (Ä‘á»ƒ menu hoáº¡t Ä‘á»™ng)
        const select = document.getElementById('batchSelect');
        if (select && select.options.length <= 2) await loadBatches();

        const res = await fetch(`${API_BASE}/vocab/learning?batchId=${currentBatchId}`, { headers: getHeaders() });
        vocabList = await res.json();
        
        if (!vocabList || vocabList.length === 0) {
            alert("Bá»™ tá»« nÃ y chÆ°a cÃ³ tá»« nÃ o. HÃ£y táº¡o bá»™ má»›i!");
            return;
        }
        vocabIndex = 0;
        updateFlashcard();
    } catch (error) { console.error(error); }
}
function updateFlashcard() {
    if (!vocabList[vocabIndex]) return;
    const item = vocabList[vocabIndex];
    
    document.getElementById('wordFront').innerText = item.word;
    document.getElementById('wordBack').innerText = item.meaning;

    // FIX: Æ¯u tiÃªn láº¥y example tá»« backend tráº£ vá»
    const exDisplay = document.getElementById('wordExample');
    if (exDisplay) {
        let ex = item.example || item.sentence || item.context;
        if (ex && ex.trim() !== "") {
            exDisplay.innerText = `"${ex}"`;
            exDisplay.classList.remove("text-gray-400");
        } else {
            exDisplay.innerText = "(ChÆ°a cÃ³ vÃ­ dá»¥)";
            exDisplay.classList.add("text-gray-400");
        }
    }
    
    // Update tiáº¿n Ä‘á»™
    document.getElementById('learningCurrent').innerText = vocabIndex + 1;
    document.getElementById('learningTotal').innerText = vocabList.length;
    document.getElementById('learningProgress').style.width = `${((vocabIndex+1)/vocabList.length)*100}%`;
    document.getElementById('flashcard').classList.remove('flipped');
}
// --- CÃC HÃ€M ÄIá»€U KHIá»‚N FLASHCARD (Bá»Š THIáº¾U) ---
    function flipCard() {
        document.getElementById('flashcard').classList.toggle('flipped');
    }

    function nextWord() {
        if (vocabIndex < vocabList.length - 1) {
            vocabIndex++;
            updateFlashcard();
        } else {
            alert("Báº¡n Ä‘Ã£ há»c háº¿t danh sÃ¡ch nÃ y!");
        }
    }

    function previousWord() {
        if (vocabIndex > 0) {
            vocabIndex--;
            updateFlashcard();
        }
    }
// --- HÃ€M PHÃT Ã‚M (TEXT TO SPEECH) ---
    function playAudio(event) {
        // 1. NgÄƒn khÃ´ng cho láº­t tháº» khi báº¥m vÃ o loa
        event.stopPropagation(); 

        // 2. Láº¥y tá»« hiá»‡n táº¡i
        if (!vocabList[vocabIndex]) return;
        const textToRead = vocabList[vocabIndex].word;

        // 3. Gá»i API cá»§a trÃ¬nh duyá»‡t Ä‘á»ƒ Ä‘á»c
        const utterance = new SpeechSynthesisUtterance(textToRead);
        utterance.lang = 'en-US'; // Giá»ng Má»¹ (hoáº·c 'en-GB' náº¿u thÃ­ch giá»ng Anh)
        utterance.rate = 0.8;     // Tá»‘c Ä‘á»™ Ä‘á»c (0.8 lÃ  vá»«a pháº£i, dá»… nghe)
        utterance.pitch = 1;      // Cao Ä‘á»™ bÃ¬nh thÆ°á»ng
        
        window.speechSynthesis.speak(utterance);
    }
   async function markAsLearned() {
    const item = vocabList[vocabIndex];
    if (!item) return;

    try {
        // FIX: URL lÃ  /vocab/master vÃ  body lÃ  vocabId
        const res = await fetch(`${API_BASE}/vocab/master`, {
            method: "POST",
            headers: getHeaders(),
            body: JSON.stringify({ vocabId: item.id }) 
        });

        if (res.ok) {
            // Cáº­p nháº­t sá»‘ Ä‘áº¿m trÃªn giao diá»‡n
            const countEl = document.getElementById('learnedCount');
            if(countEl) {
                let c = parseInt(countEl.innerText.replace(/\D/g,'')) || 0;
                countEl.innerText = `ÄÃ£ há»c: ${c + 1}`;
            }
            nextWord(); 
        } else {
            alert("Lá»—i server khi lÆ°u tá»«!");
        }
    } catch (e) { console.error(e); }
}
// --- HÃ€M Táº O Bá»˜ Tá»ª Má»šI (DÃ¡n Ä‘oáº¡n nÃ y vÃ o cuá»‘i tháº» script) ---
    async function generateNewBatch(btn) {
        // Há»i xÃ¡c nháº­n
        if(!confirm("ğŸ¤– AI sáº½ táº¡o thÃªm 15 tá»« vá»±ng má»›i cho báº¡n.\nQuÃ¡ trÃ¬nh nÃ y máº¥t khoáº£ng 10-20 giÃ¢y.\n\nBáº¡n cÃ³ muá»‘n tiáº¿p tá»¥c?")) return;

        const originalText = btn.innerText;
        btn.innerText = "â³ Äang táº¡o...";
        btn.disabled = true;

        try {
            const focusWords = Array.from(hardWords);
            if (focusWords.length) await sendHardWords("new-batch");

            const res = await fetch(`${API_BASE}/vocab/more`, { 
                method: "POST", 
                headers: getHeaders(),
                body: JSON.stringify({ focusWords })
            });
            const data = await res.json();

            if (res.ok) {
                alert(`âœ… ThÃ nh cÃ´ng! ÄÃ£ táº¡o xong bá»™ tá»« má»›i gá»“m ${data.count} tá»«.`);
                
                // Táº£i láº¡i danh sÃ¡ch dropdown
                await loadBatches(); 
                
                // Tá»± Ä‘á»™ng chuyá»ƒn sang bá»™ vá»«a táº¡o
                const select = document.getElementById('batchSelect');
                if(select && data.batchId) {
                    select.value = data.batchId; 
                    changeBatch(); 
                }
            } else {
                alert("âš ï¸ Lá»—i: " + (data.message || "KhÃ´ng táº¡o Ä‘Æ°á»£c bá»™ tá»«."));
            }
        } catch (e) {
            console.error(e);
            alert("Lá»—i káº¿t ná»‘i tá»›i Server AI.");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
// --- LOGIC GAME Má»šI (ÄÃƒ FIX Lá»–I) ---
    let currentGameData = null;

    async function initGames() {
        showSection('games');
        
        // Reset giao diá»‡n: Hiá»‡n menu, áº©n khu vá»±c chÆ¡i
        document.getElementById('gameMenu').classList.remove('hidden');
        document.getElementById('gamePlayArea').innerHTML = '';
        
        const container = document.getElementById('gamePlayArea');
        container.innerHTML = '<div class="text-center mt-10"><div class="loading-dots text-2xl text-pink-500">ğŸ¤– AI Ä‘ang táº£i dá»¯ liá»‡u trÃ² chÆ¡i...</div></div>';

        try {
            // Gá»i API láº¥y dá»¯ liá»‡u
            const res = await fetch(`${API_BASE}/vocab/game?batchId=${currentBatchId}`, { headers: getHeaders() });
            const data = await res.json();
            currentGameData = data;

            // XÃ³a loading sau khi táº£i xong
            container.innerHTML = ''; 

            if (!data || (!data.matching && !data.speedMatch)) {
                alert("Bá»™ tá»« nÃ y chÆ°a Ä‘á»§ dá»¯ liá»‡u Ä‘á»ƒ chÆ¡i game. HÃ£y há»c thÃªm tá»« má»›i nhÃ©!");
            }
        } catch (e) {
            console.error(e);
            container.innerHTML = '<div class="text-center mt-10 text-red-500">Lá»—i káº¿t ná»‘i Game Server</div>';
        }
    }

    // Helper: Quay láº¡i menu game
    function backToGameMenu() {
        document.getElementById('gameMenu').classList.remove('hidden');
        document.getElementById('gamePlayArea').innerHTML = '';
    }

    // 1. GAME MATCHING
    function playMatching() {
        if(!currentGameData?.matching?.length) return alert("ChÆ°a cÃ³ dá»¯ liá»‡u cho game nÃ y.");
        
        // áº¨n menu, hiá»‡n game
        document.getElementById('gameMenu').classList.add('hidden');
        
        let cards = [];
        currentGameData.matching.forEach(item => {
            cards.push({ id: item.id, text: item.term, type: 'term' });
            cards.push({ id: item.id, text: item.match, type: 'match' });
        });
        cards.sort(() => 0.5 - Math.random());

        document.getElementById('gamePlayArea').innerHTML = `
            <div class="mb-4 flex justify-between items-center">
                <h3 class="text-xl font-bold text-pink-600">ğŸ´ Ná»‘i tá»«</h3>
                <button onclick="backToGameMenu()" class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">ThoÃ¡t</button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                ${cards.map(c => `
                    <div onclick="handleMatchClick(this, '${c.id}')" 
                         class="bg-white h-24 flex items-center justify-center p-2 text-center border-2 border-gray-200 rounded-xl cursor-pointer hover:border-pink-400 font-semibold shadow-sm select-none transition-all" 
                         data-id="${c.id}">
                        ${c.text}
                    </div>
                `).join('')}
            </div>
        `;
        window.selectedCard = null;
        window.matchedCount = 0;
    }

    window.handleMatchClick = function(el, id) {
        if (el.classList.contains('bg-green-100') || el === window.selectedCard) return;
        el.classList.add('border-pink-500', 'bg-pink-50');

        if (!window.selectedCard) {
            window.selectedCard = el;
        } else {
            const prevEl = window.selectedCard;
            const prevId = prevEl.getAttribute('data-id');

            if (prevId === id) {
                // ÄÃºng
                [el, prevEl].forEach(card => {
                    card.className = "bg-green-100 h-24 flex items-center justify-center p-2 text-center border-2 border-green-500 rounded-xl font-bold text-green-700 opacity-50";
                });
                window.matchedCount++;
                if (window.matchedCount === currentGameData.matching.length) {
                    setTimeout(() => alert("ğŸ‰ Xuáº¥t sáº¯c! Báº¡n Ä‘Ã£ hoÃ n thÃ nh."), 300);
                }
            } else {
                // Sai
                setTimeout(() => {
                    el.classList.remove('border-pink-500', 'bg-pink-50');
                    prevEl.classList.remove('border-pink-500', 'bg-pink-50');
                }, 500);
            }
            window.selectedCard = null;
        }
    }

    // 2. GAME SPEED MATCH
    function playSpeedMatch() {
        const questions = currentGameData?.speedMatch;
        if(!questions?.length) return alert("ChÆ°a cÃ³ dá»¯ liá»‡u cho game nÃ y.");

        document.getElementById('gameMenu').classList.add('hidden');
        let qIndex = 0;
        let score = 0;

        function renderQ() {
            if (qIndex >= questions.length) {
                document.getElementById('gamePlayArea').innerHTML = `
                    <div class="text-center mt-10">
                        <h2 class="text-3xl font-bold mb-4 text-gray-800">ğŸ Káº¿t thÃºc!</h2>
                        <p class="text-xl">Äiá»ƒm sá»‘: <span class="text-pink-600 font-bold">${score}/${questions.length}</span></p>
                        <button onclick="backToGameMenu()" class="mt-6 btn-pink text-white px-6 py-2 rounded-lg">Quay láº¡i Menu</button>
                    </div>`;
                return;
            }
            const q = questions[qIndex];
            document.getElementById('gamePlayArea').innerHTML = `
                <div class="max-w-md mx-auto mt-4 p-6 bg-white rounded-2xl shadow-xl text-center border border-blue-100">
                    <div class="flex justify-between text-gray-400 mb-4 text-xs">
                        <span>CÃ¢u ${qIndex + 1}/${questions.length}</span>
                        <button onclick="backToGameMenu()" class="underline">ThoÃ¡t</button>
                    </div>
                    <h3 class="text-4xl font-extrabold text-gray-800 mb-2">${q.word}</h3>
                    <p class="text-gray-400 mb-6">cÃ³ nghÄ©a lÃ </p>
                    <div class="text-xl font-bold text-blue-600 mb-10 p-4 bg-blue-50 rounded-xl border border-blue-100">
                        "${q.meaning}"
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="checkSpeed(false)" class="bg-red-100 text-red-600 py-4 rounded-xl font-bold hover:bg-red-200 text-xl">SAI âŒ</button>
                        <button onclick="checkSpeed(true)" class="bg-green-100 text-green-600 py-4 rounded-xl font-bold hover:bg-green-200 text-xl">ÄÃšNG âœ…</button>
                    </div>
                </div>`;
        }

        window.checkSpeed = function(userAnswer) {
            const isCorrect = questions[qIndex].isCorrect;
            if (userAnswer === isCorrect) {
                score++;
                alert("âœ… ChÃ­nh xÃ¡c!");
            } else {
                alert("âŒ Sai rá»“i!");
            }
            qIndex++;
            renderQ();
        }
        renderQ();
    }

    // 3. GAME WORD HUNT
    function playWordHunt() {
        const words = currentGameData?.wordHunt?.words;
        if(!words?.length) return alert("ChÆ°a cÃ³ dá»¯ liá»‡u cho game nÃ y.");

        document.getElementById('gameMenu').classList.add('hidden');
        
        // Táº¡o grid giáº£ láº­p (trong thá»±c táº¿ cáº§n thuáº­t toÃ¡n xáº¿p chá»¯ phá»©c táº¡p hÆ¡n)
        const gridSize = 10;
        const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        let grid = Array(gridSize).fill(null).map(() => Array(gridSize).fill(''));
        
        // Äáº·t tá»« vÃ o grid (ngang)
        words.forEach((w, i) => { 
            if(i < gridSize) {
                for(let j=0; j<w.length && j < gridSize; j++) {
                    grid[i][j] = w[j];
                }
            }
        });
        
        // Äiá»n kÃ½ tá»± ngáº«u nhiÃªn vÃ o chá»— trá»‘ng
        for(let r=0; r<gridSize; r++) {
            for(let c=0; c<gridSize; c++) {
                if(grid[r][c] === '') grid[r][c] = letters[Math.floor(Math.random() * letters.length)];
            }
        }

        document.getElementById('gamePlayArea').innerHTML = `
            <div class="max-w-4xl mx-auto p-4 flex flex-col items-center">
                <div class="w-full flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-green-600">ğŸ” TÃ¬m cÃ¡c tá»« sau:</h2>
                    <button onclick="backToGameMenu()" class="text-sm underline text-gray-500">ThoÃ¡t</button>
                </div>
                <div class="flex flex-wrap gap-2 mb-4 justify-center">
                    ${words.map(w => `<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm font-bold">${w}</span>`).join('')}
                </div>
                <div class="grid grid-cols-10 gap-1 bg-gray-100 p-2 rounded-lg select-none shadow-inner">
                    ${grid.flat().map(c => `
                        <div class="w-8 h-8 md:w-10 md:h-10 bg-white flex items-center justify-center font-bold text-gray-700 cursor-pointer hover:bg-green-200 rounded" 
                             onclick="this.classList.toggle('bg-green-500'); this.classList.toggle('text-white')">
                            ${c}
                        </div>
                    `).join('')}
                </div>
            </div>`;
    }
// ==========================================
// --- LOGIC KIá»‚M TRA (TEST SECTION) ---

    async function initTestSection() {
        showSection('test');
        hardWords.clear();
        activeTestIndex = 0;
        if (aiCamera?.resetStruggle) aiCamera.resetStruggle();
        await ensureTestAICamera();
        
        // Reset giao diá»‡n vá» tráº¡ng thÃ¡i ban Ä‘áº§u
        document.getElementById('testLoading').classList.remove('hidden');
        document.getElementById('testQuiz').classList.add('hidden');
        document.getElementById('testResult').classList.add('hidden');
        document.getElementById('testSubmit').classList.remove('hidden');
        document.getElementById('testRetry').classList.add('hidden');
        document.getElementById('testScoreDisplay').classList.add('hidden');
        
        try {
            // Gá»i API láº¥y cÃ¢u há»i
            const res = await fetch(`${API_BASE}/vocab/test?batchId=${currentBatchId}`, { headers: getHeaders() });
            const data = await res.json();
            
            document.getElementById('testLoading').classList.add('hidden');

            if (data.questions && data.questions.length > 0) {
                currentTestQs = data.questions;
                renderTest(); // Váº½ cÃ¢u há»i ra mÃ n hÃ¬nh
                document.getElementById('testQuiz').classList.remove('hidden');
            } else {
                document.getElementById('testQuestions').innerHTML = `
                    <div class="text-center py-10 text-red-500">
                        <p class="text-xl font-bold">âš ï¸ ChÆ°a Ä‘á»§ dá»¯ liá»‡u</p>
                        <p class="mt-2">Báº¡n cáº§n há»c Ã­t nháº¥t 5 tá»« vá»±ng Ä‘á»ƒ táº¡o bÃ i kiá»ƒm tra.</p>
                        <button onclick="checkDataAndShow('learning')" class="mt-6 text-pink-600 underline font-bold">Äi há»c tá»« ngay</button>
                    </div>`;
                document.getElementById('testQuiz').classList.remove('hidden');
                document.getElementById('testSubmit').classList.add('hidden');
            }
        } catch (e) {
            console.error(e);
            document.getElementById('testLoading').classList.add('hidden');
            alert("Lá»—i káº¿t ná»‘i AI server. Vui lÃ²ng thá»­ láº¡i sau.");
        }
    }

    function renderTest() {
        const container = document.getElementById('testQuestions');
        container.innerHTML = currentTestQs.map((q, idx) => `
            <div class="question-card bg-gray-50 p-6 rounded-2xl border border-gray-200 transition-all hover:shadow-md" id="q-card-${idx}" onclick="setActiveTestIndex(${idx})">
                <div class="flex items-start gap-3 mb-4">
                    <span class="bg-pink-100 text-pink-600 font-bold px-3 py-1 rounded-lg text-sm whitespace-nowrap">CÃ¢u ${idx+1}</span>
                    <p class="font-bold text-lg text-gray-800 leading-relaxed pt-1">${q.question}</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="group-${idx}">
                    ${q.options.map(opt => `
                        <label class="option-label flex items-center p-4 border-2 border-white bg-white rounded-xl cursor-pointer hover:border-pink-200 shadow-sm transition-all group">
                            <input type="radio" name="q${idx}" value="${opt}" class="w-5 h-5 text-pink-600 accent-pink-500 mr-3" onchange="setActiveTestIndex(${idx}); updateTestProgress()">
                            <span class="font-medium text-gray-600 group-hover:text-gray-900">${opt}</span>
                        </label>
                    `).join('')}
                </div>

                <div id="explain-${idx}" class="hidden mt-6 pt-6 border-t border-gray-200 animation-fade-in">
                    <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 text-sm">
                        <p class="text-green-700 font-bold text-base mb-2">âœ… ÄÃ¡p Ã¡n Ä‘Ãºng: ${q.correctAnswer}</p>
                        <p class="text-gray-700 mb-4"><span class="font-bold">ğŸ’¡ Giáº£i thÃ­ch:</span> ${q.explanation || "ChÆ°a cÃ³ giáº£i thÃ­ch chi tiáº¿t."}</p>
                        
                        <div class="bg-white p-3 rounded-lg border border-blue-100">
                            <p class="font-bold text-gray-500 mb-2 text-xs uppercase tracking-wider">Tá»« vá»±ng trong cÃ¢u:</p>
                            <ul class="space-y-1">
                                ${Object.entries(q.meanings || {}).map(([key, val]) => 
                                    `<li class="flex justify-between border-b border-gray-100 pb-1 last:border-0">
                                        <span class="font-semibold text-gray-800">${key}</span>
                                        <span class="text-gray-500">${val}</span>
                                    </li>`
                                ).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('testProgress').style.width = '0%';
        setActiveTestIndex(0);
    }

    function updateTestProgress() {
        const total = currentTestQs.length;
        const answered = document.querySelectorAll('#testQuestions input[type="radio"]:checked').length;
        document.getElementById('testProgress').style.width = `${(answered/total)*100}%`;
    }

    function submitTest() {
        // Kiá»ƒm tra xem Ä‘Ã£ lÃ m háº¿t chÆ°a
        const answered = document.querySelectorAll('#testQuestions input[type="radio"]:checked').length;
        if (answered < currentTestQs.length) {
            if(!confirm(`Báº¡n má»›i lÃ m ${answered}/${currentTestQs.length} cÃ¢u. Báº¡n cÃ³ cháº¯c muá»‘n ná»™p bÃ i khÃ´ng?`)) return;
        }

        let score = 0;
        
        currentTestQs.forEach((q, idx) => {
            const selectedInput = document.querySelector(`input[name="q${idx}"]:checked`);
            const userAns = selectedInput ? selectedInput.value : null;
            const explainDiv = document.getElementById(`explain-${idx}`);
            const group = document.getElementById(`group-${idx}`);

            // 1. KhÃ³a khÃ´ng cho chá»n láº¡i
            group.querySelectorAll('input').forEach(i => i.disabled = true);
            group.querySelectorAll('label').forEach(l => l.classList.add('cursor-default'));

            // 2. Cháº¥m Ä‘iá»ƒm
            let isCorrect = false;
            if (userAns === q.correctAnswer) {
                score++;
                isCorrect = true;
            }

            // 3. TÃ´ mÃ u Ä‘Ã¡p Ã¡n
            group.querySelectorAll('label').forEach(label => {
                const input = label.querySelector('input');
                const val = input.value;

                // Reset style cÅ©
                label.classList.remove('bg-white', 'border-white', 'hover:border-pink-200');

                if (val === q.correctAnswer) {
                    // ÄÃ¡p Ã¡n ÄÃšNG -> Xanh lÃ¡
                    label.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                    label.innerHTML += ' <span class="ml-auto text-xl font-bold">âœ…</span>';
                } else if (val === userAns && !isCorrect) {
                    // ÄÃ¡p Ã¡n SAI ngÆ°á»i dÃ¹ng chá»n -> Äá»
                    label.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                    label.innerHTML += ' <span class="ml-auto text-xl font-bold">âŒ</span>';
                } else {
                    // CÃ¡c Ä‘Ã¡p Ã¡n cÃ²n láº¡i -> Má» Ä‘i
                    label.classList.add('bg-gray-50', 'border-transparent', 'opacity-50');
                }
            });

            // 4. Hiá»‡n giáº£i thÃ­ch
            explainDiv.classList.remove('hidden');
        });

        // 5. Hiá»ƒn thá»‹ káº¿t quáº£ tá»•ng
        document.getElementById('testSubmit').classList.add('hidden');
        document.getElementById('testRetry').classList.remove('hidden');
        document.getElementById('testResult').classList.remove('hidden');
        document.getElementById('testScoreDisplay').classList.remove('hidden');
        
        document.getElementById('testFinalScore').innerText = score;
        document.getElementById('testScoreDisplay').innerText = `Äiá»ƒm: ${score}/${currentTestQs.length}`;

        // Feedback
        const percent = (score / currentTestQs.length);
        const fb = document.getElementById('testFeedback');
        if (percent === 1) fb.innerText = "ğŸŒŸ Xuáº¥t sáº¯c! Báº¡n Ä‘Ã£ lÃ m chá»§ hoÃ n toÃ n cÃ¡c tá»« vá»±ng nÃ y.";
        else if (percent >= 0.8) fb.innerText = "ğŸ”¥ Ráº¥t tá»‘t! Chá»‰ cÃ²n má»™t vÃ i lá»—i nhá» thÃ´i.";
        else if (percent >= 0.5) fb.innerText = "ğŸ‘ KhÃ¡ á»•n! HÃ£y xem ká»¹ pháº§n giáº£i thÃ­ch cÃ¡c cÃ¢u sai nhÃ©.";
        else fb.innerText = "ğŸ’ª Cáº§n cá»‘ gáº¯ng hÆ¡n! HÃ£y Ã´n táº­p láº¡i bá»™ tá»« vá»±ng nÃ y.";

        // Cuá»™n mÃ n hÃ¬nh Ä‘áº¿n pháº§n káº¿t quáº£
        document.getElementById('testResult').scrollIntoView({ behavior: 'smooth', block: 'center' });
        sendHardWords("test-submit");
    }
</script>
<div id="aiCameraContainer" class="fixed bottom-4 right-4 z-50 hidden transition-all">
    <div class="relative w-32 h-24 border-2 border-blue-400 rounded-xl overflow-hidden shadow-lg bg-black">
        <video id="aiVideo" width="320" height="240" autoplay muted playsinline class="w-full h-full object-cover transform scale-x-[-1]"></video>
        <div class="absolute top-0 right-0 bg-blue-500 text-white text-[10px] px-1">AI ON</div>
    </div>
</div>

<script src="/_sdk/face-api.min.js"></script> <script src="/_sdk/ai_camera.js"></script>
 </body>
</html>