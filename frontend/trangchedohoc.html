<!doctype html>
<html lang="vi" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H·ªçc t·ª´ v·ª±ng - English Blossom AI</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.6s ease-out forwards; }
    .gradient-bg { background: linear-gradient(135deg, #fce7f3 0%, #ffffff 50%, #fff1f2 100%); }
    .gradient-text { background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .btn-pink { transition: all 0.3s ease; background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); }
    .btn-pink:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(236, 72, 153, 0.4); }
    .card-3d { perspective: 1000px; transition: transform 0.3s ease; }
    .card-3d:hover { transform: translateY(-5px); }
    .flashcard { position: relative; width: 100%; height: 300px; transform-style: preserve-3d; transition: transform 0.6s; }
    .flashcard.flipped { transform: rotateY(180deg); }
    .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 1.5rem; padding: 2rem; }
    .flashcard-back { transform: rotateY(180deg); }
    .word-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem; }
    .word-cell { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; font-weight: bold; background: white; border: 2px solid #fbcfe8; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; user-select: none; }
    .word-cell:hover { background: #fce7f3; transform: scale(1.1); }
    .word-cell.selected { background: #ec4899; color: white; border-color: #ec4899; }
    .word-cell.found { background: #86efac; color: #166534; border-color: #86efac; }
    .progress-bar { height: 8px; background: #fbcfe8; border-radius: 9999px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); transition: width 0.3s ease; }
    .hidden { display: none !important; }
    .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
    @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full w-full">
  <div id="app" class="w-full h-full overflow-auto gradient-bg">
   <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
     <div class="flex items-center"><span class="text-4xl mr-3">üå∏</span>
      <div>
       <h1 id="pageTitle" class="text-2xl font-bold gradient-text">English Blossom AI</h1>
       <p class="text-sm text-gray-600">H·ªçc th√¥ng minh - L·ªô tr√¨nh c√° nh√¢n h√≥a</p>
      </div>
     </div><button onclick="showSection('menu')" class="btn-pink text-white px-6 py-2 rounded-xl font-semibold"> üìö Menu </button>
    <button onclick="toggleAICamera()" class="ml-4 bg-gray-800 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-gray-700 flex items-center gap-2">
    üëÅÔ∏è AI Camera: <span id="aiStatus">OFF</span>
</button>
     </div>
   </header>

   <main class="max-w-7xl mx-auto px-6 py-8">
    <section id="menu" class="fade-in">
     <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="card-3d bg-white rounded-2xl p-6 shadow-lg cursor-pointer" onclick="showSection('assessment')">
       <div class="text-5xl mb-4 text-center">üéØ</div>
       <h3 class="text-xl font-bold text-center mb-2 gradient-text">Test ƒê·∫ßu V√†o</h3>
       <p class="text-gray-600 text-center text-sm">AI Adaptive Test (A1-C1)</p>
      </div>
      <div class="card-3d bg-white rounded-2xl p-6 shadow-lg cursor-pointer" onclick="checkDataAndShow('learning')">
       <div class="text-5xl mb-4 text-center">üìñ</div>
       <h3 class="text-xl font-bold text-center mb-2 gradient-text">H·ªçc T·ª´ M·ªõi</h3>
       <p class="text-gray-600 text-center text-sm">L·ªô tr√¨nh AI t·∫°o ri√™ng cho b·∫°n</p>
      </div>
      <div class="card-3d bg-white rounded-2xl p-6 shadow-lg cursor-pointer" onclick="checkDataAndShow('games')">
       <div class="text-5xl mb-4 text-center">üéÆ</div>
       <h3 class="text-xl font-bold text-center mb-2 gradient-text">Game √în T·∫≠p</h3>
       <p class="text-gray-600 text-center text-sm">Matching, Word Hunt, Speed</p>
      </div>
      <div class="card-3d bg-white rounded-2xl p-6 shadow-lg cursor-pointer" onclick="initTestSection()">
       <div class="text-5xl mb-4 text-center">‚úÖ</div>
       <h3 class="text-xl font-bold text-center mb-2 gradient-text">Ki·ªÉm Tra</h3>
       <p class="text-gray-600 text-center text-sm">C√¢u h·ªèi t√¨nh hu·ªëng (Context)</p>
      </div>
     </div>
     <div class="mt-8 text-center text-gray-500 italic text-sm">
        * L∆∞u √Ω: H·ªá th·ªëng s·ª≠ d·ª•ng AI th·ªùi gian th·ª±c, vui l√≤ng ƒë·ª£i v√†i gi√¢y khi t·∫°o n·ªôi dung.
     </div>
    </section>

    <section id="assessment" class="hidden">
     <div class="bg-white rounded-2xl p-8 shadow-lg max-w-3xl mx-auto">
      <h2 class="text-3xl font-bold gradient-text mb-6 text-center">üéØ ƒê√°nh gi√° nƒÉng l·ª±c th·ª±c t·∫ø</h2>
      
      <div id="assessmentIntro" class="text-center">
          <p class="mb-6 text-gray-600">AI s·∫Ω ƒë∆∞a ra c√°c c√¢u h·ªèi ƒë·ªÉ x√°c ƒë·ªãnh tr√¨nh ƒë·ªô c·ªßa b·∫°n (A1 ƒë·∫øn C1).<br>H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh ƒë·ªô kh√≥ d·ª±a tr√™n c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n.</p>
          <button onclick="startPlacement()" class="btn-pink text-white px-8 py-3 rounded-xl font-semibold">B·∫Øt ƒë·∫ßu Test</button>
      </div>

      <div id="assessmentLoading" class="hidden text-center py-10">
          <div class="text-5xl mb-4 animate-bounce">ü§ñ</div>
          <p class="text-lg font-semibold text-pink-600">AI ƒëang so·∫°n c√¢u h·ªèi m·ªõi ph√π h·ª£p v·ªõi b·∫°n<span class="loading-dots"></span></p>
      </div>

      <div id="assessmentQuiz" class="hidden space-y-6">
       <div class="mb-4">
        <div class="flex justify-between text-sm text-gray-600 mb-2">
            <span>ƒê·ªô kh√≥ hi·ªán t·∫°i: <span id="currentDiffDisplay" class="font-bold text-pink-500">A1</span></span> 
            <span id="assessmentScore">Ti·∫øn ƒë·ªô: 0/10</span>
        </div>
        <div class="progress-bar">
         <div id="assessmentProgress" class="progress-fill" style="width: 0%"></div>
        </div>
       </div>
       <div id="assessmentQuestion" class="bg-pink-50 p-6 rounded-xl min-h-[200px]">
        </div>
      </div>
      
      <div id="assessmentResult" class="hidden">
        <div class="text-center">
            <div class="text-6xl mb-4">üéâ</div>
            <h3 class="text-2xl font-bold gradient-text mb-4">K·∫øt qu·∫£ ƒë√°nh gi√°</h3>
            <div class="bg-pink-50 p-6 rounded-xl mb-6">
                <p class="text-lg mb-2">Tr√¨nh ƒë·ªô x√°c ƒë·ªãnh: <span id="finalLevel" class="font-bold text-pink-600 text-2xl">Beginner</span></p>
                <p class="text-gray-600 mt-2 italic" id="levelDescription">...</p>
            </div>
        </div>
        
        <div id="preferenceForm" class="bg-white border-2 border-pink-100 p-6 rounded-xl mb-6">
            <h4 class="font-bold text-lg mb-4 text-pink-600 border-b pb-2">üìã Thi·∫øt l·∫≠p l·ªô tr√¨nh h·ªçc t·∫≠p chi ti·∫øt</h4>
            
            <div class="grid md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Ch·ªß ƒë·ªÅ quan t√¢m nh·∫•t:</label>
                    <select id="topicSelect" class="w-full p-2 border border-pink-200 rounded-lg focus:border-pink-500 outline-none">
                        <option value="Daily Communication">Giao ti·∫øp h√†ng ng√†y (Daily Life)</option>
                        <option value="Business English">Ti·∫øng Anh c√¥ng s·ªü & H·ªçp h√†nh</option>
                        <option value="Travel & Adventure">Du l·ªãch & Kh√°m ph√° vƒÉn h√≥a</option>
                        <option value="Technology & IT">C√¥ng ngh·ªá & K·ªπ thu·∫≠t (IT)</option>
                        <option value="IELTS Academic">T·ª´ v·ª±ng h·ªçc thu·∫≠t (IELTS/TOEIC)</option>
                        <option value="Medical English">Ti·∫øng Anh Y khoa</option>
                        <option value="Marketing & Sales">Marketing & B√°n h√†ng</option>
                    </select>
                </div>
                <div>
                     <label class="block text-gray-700 text-sm font-bold mb-2">Phong c√°ch h·ªçc:</label>
                     <select id="styleSelect" class="w-full p-2 border border-pink-200 rounded-lg focus:border-pink-500 outline-none">
                        <option value="formal">Trang tr·ªçng (Formal)</option>
                        <option value="casual">Th√¢n m·∫≠t, t·ª± nhi√™n (Casual/Slang)</option>
                        <option value="idiomatic">T·∫≠p trung th√†nh ng·ªØ (Idioms)</option>
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">M·ª•c ti√™u c·ª• th·ªÉ (AI s·∫Ω t·ªëi ∆∞u v√≠ d·ª• theo ƒë√¢y):</label>
                <input type="text" id="userGoal" class="w-full p-2 border border-pink-200 rounded-lg" placeholder="VD: Vi·∫øt email cho kh√°ch h√†ng, ph·ªèng v·∫•n xin vi·ªác..." value="Giao ti·∫øp t·ª± tin">
            </div>
        </div>

        <button id="btnGenerate" onclick="submitPreferences()" class="w-full py-3 btn-pink text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all">
    ‚ú® AI T·∫°o l·ªô tr√¨nh ngay
</button>
      </div>
     </div>
    </section>

    <section id="learning" class="hidden">
     <div class="bg-white rounded-2xl p-8 shadow-lg max-w-3xl mx-auto">
      <h2 class="text-3xl font-bold gradient-text mb-6 text-center">üìñ H·ªçc t·ª´ m·ªõi (AI Generated)</h2>
      

<div class="mb-4 flex justify-center items-center gap-2">
    <select id="batchSelect" onchange="changeBatch()" class="flex-1 p-3 border-2 border-pink-300 rounded-xl bg-white text-gray-700 font-semibold shadow-sm focus:outline-none focus:border-pink-500 transition-all max-w-sm">
        <option value="latest">‚≠ê B·ªô t·ª´ m·ªõi nh·∫•t</option>
        <option disabled>ƒêang t·∫£i danh s√°ch...</option>
    </select>
    
    <button onclick="generateNewBatch(this)" class="bg-pink-100 text-pink-600 px-4 py-3 rounded-xl font-bold hover:bg-pink-200 transition-all whitespace-nowrap border-2 border-pink-200 shadow-sm">
        + B·ªô m·ªõi
    </button>
</div>
      <div class="mb-6">
       <div class="flex justify-between text-sm text-gray-600 mb-2"><span>T·ª´ <span id="learningCurrent">1</span>/<span id="learningTotal">20</span></span> <span id="learnedCount">ƒê√£ h·ªçc: 0</span>
       </div>
       <div class="progress-bar">
        <div id="learningProgress" class="progress-fill" style="width: 5%"></div>
       </div>
      </div>
      <div class="flashcard cursor-pointer" id="flashcard" onclick="flipCard()">
       <div class="flashcard-face flashcard-front bg-gradient-to-br from-pink-100 to-pink-50 shadow-xl border border-pink-200">
        <div class="text-center w-full px-4">
         <p class="text-sm text-pink-600 font-bold mb-4 uppercase tracking-widest">Vocabulary</p>
         <h3 id="wordFront" class="text-5xl font-extrabold text-gray-800 mb-2">Loading...</h3>
         <button onclick="playAudio(event)" class="mt-3 bg-white border border-pink-200 text-pink-600 px-4 py-2 rounded-full font-bold hover:bg-pink-50 hover:shadow-md transition-all flex items-center justify-center mx-auto gap-2">
    üîä Nghe ph√°t √¢m
</button>
         <p id="wordType" class="text-lg text-pink-500 italic font-serif mb-4">...</p>
         <p class="text-sm text-gray-400 mt-8">Nh·∫•n ƒë·ªÉ xem nghƒ©a</p>
        </div>
       </div>
       <div class="flashcard-face flashcard-back bg-gradient-to-br from-rose-100 to-rose-50 shadow-xl border border-rose-200">
        <div class="text-center w-full px-4">
         <p class="text-sm text-rose-600 font-bold mb-4 uppercase tracking-widest">Meaning & Context</p>
         <h3 id="wordBack" class="text-3xl font-bold text-gray-800 mb-4">...</h3>
         <div class="bg-white/60 p-4 rounded-xl text-left inline-block shadow-sm">
             <p class="text-lg text-gray-700 italic font-medium" id="wordExample">"..."</p>
         </div>
         <p id="wordNote" class="text-sm text-gray-500 mt-4"></p>
        </div>
       </div>
      </div>
      <div class="flex gap-4 mt-8"><button onclick="previousWord()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-colors"> ‚Üê Tr∆∞·ªõc </button> <button onclick="markAsLearned()" class="flex-1 bg-green-500 text-white py-3 rounded-xl font-semibold hover:bg-green-600 transition-colors"> ‚úì ƒê√£ nh·ªõ </button> <button onclick="nextWord()" class="flex-1 btn-pink text-white py-3 rounded-xl font-semibold"> Ti·∫øp ‚Üí </button>
      </div>
     </div>
    </section>
<section id="games" class="hidden">
     <div class="bg-white rounded-2xl p-8 shadow-lg max-w-5xl mx-auto">
      <h2 class="text-3xl font-bold gradient-text mb-6 text-center">üéÆ Game √¥n t·∫≠p</h2>
      
      <div id="gameMenu" class="grid md:grid-cols-3 gap-6 mb-8">
        <button onclick="playMatching()" class="card-3d bg-gradient-to-br from-pink-50 to-white p-6 rounded-xl border-2 border-pink-200 cursor-pointer hover:shadow-xl transition-all">
            <div class="text-4xl mb-3 text-center">üé¥</div>
            <h3 class="font-bold text-lg text-center mb-2 text-pink-600">N·ªëi T·ª´ (Matching)</h3>
            <p class="text-sm text-gray-600 text-center">Gh√©p t·ª´ v·ª±ng v·ªõi nghƒ©a</p>
        </button> 
        <button onclick="playWordHunt()" class="card-3d bg-gradient-to-br from-green-50 to-white p-6 rounded-xl border-2 border-green-200 cursor-pointer hover:shadow-xl transition-all">
            <div class="text-4xl mb-3 text-center">üîç</div>
            <h3 class="font-bold text-lg text-center mb-2 text-green-600">T√¨m T·ª´ (Word Hunt)</h3>
            <p class="text-sm text-gray-600 text-center">T√¨m t·ª´ ·∫©n trong √¥ ch·ªØ</p>
        </button> 
        <button onclick="playSpeedMatch()" class="card-3d bg-gradient-to-br from-blue-50 to-white p-6 rounded-xl border-2 border-blue-200 cursor-pointer hover:shadow-xl transition-all">
            <div class="text-4xl mb-3 text-center">‚ö°</div>
            <h3 class="font-bold text-lg text-center mb-2 text-blue-600">Ph·∫£n X·∫° (Speed)</h3>
            <p class="text-sm text-gray-600 text-center">ƒê√∫ng/Sai trong 3 gi√¢y</p>
        </button>
      </div>

      <div id="gamePlayArea"></div>
     </div>
    </section>

<section id="test" class="hidden">
     <div class="bg-white rounded-2xl p-8 shadow-lg max-w-4xl mx-auto">
      <div class="text-center mb-8">
          <h2 class="text-3xl font-bold gradient-text mb-2">‚úÖ Ki·ªÉm tra nƒÉng l·ª±c</h2>
          <p class="text-gray-500">20 c√¢u h·ªèi tr·∫Øc nghi·ªám ‚Ä¢ Gi·∫£i th√≠ch chi ti·∫øt</p>
      </div>
      
      <div id="testLoading" class="hidden text-center py-12">
          <div class="text-6xl mb-4 animate-bounce">üìù</div>
          <h3 class="text-xl font-bold text-pink-600 mb-2">AI ƒëang so·∫°n ƒë·ªÅ thi...</h3>
          <p class="text-gray-500">ƒêang ph√¢n t√≠ch b·ªô t·ª´ v·ª±ng v√† t·∫°o t√¨nh hu·ªëng (kho·∫£ng 10-15s)</p>
      </div>

      <div id="testQuiz" class="hidden">
       <div class="sticky top-0 bg-white z-10 py-4 border-b mb-6 shadow-sm">
        <div class="flex justify-between items-center mb-2">
            <span class="font-bold text-gray-700">Ti·∫øn ƒë·ªô l√†m b√†i</span>
            <span id="testScoreDisplay" class="font-bold text-pink-600 hidden">0/20</span>
        </div>
        <div class="h-3 bg-gray-100 rounded-full overflow-hidden">
         <div id="testProgress" class="h-full bg-pink-500 transition-all duration-500" style="width: 0%"></div>
        </div>
       </div>

       <div id="testQuestions" class="space-y-8"></div>
       
       <div class="mt-8 pt-6 border-t">
           <button id="testSubmit" onclick="submitTest()" class="w-full btn-pink text-white py-4 rounded-2xl font-bold text-xl shadow-lg hover:shadow-xl hover:scale-[1.01] transition-all"> 
               üöÄ N·ªòP B√ÄI & XEM GI·∫¢I TH√çCH 
           </button>
           <button id="testRetry" onclick="initTestSection()" class="hidden w-full bg-gray-200 text-gray-700 py-4 rounded-2xl font-bold text-xl hover:bg-gray-300 transition-all"> 
               üîÑ L√†m ƒë·ªÅ kh√°c 
           </button>
       </div>
      </div>

      <div id="testResult" class="hidden text-center py-8">
       <div class="text-7xl mb-4">üèÜ</div>
       <h3 class="text-3xl font-bold gradient-text mb-4">K·∫øt qu·∫£ c·ªßa b·∫°n</h3>
       <div class="bg-pink-50 p-8 rounded-2xl border-2 border-pink-100 inline-block mb-8">
        <p class="text-lg text-gray-600 mb-2">T·ªïng ƒëi·ªÉm</p>
        <p class="text-5xl font-extrabold text-pink-600"><span id="testFinalScore">0</span><span class="text-2xl text-gray-400">/20</span></p>
       </div>
       <p id="testFeedback" class="text-xl text-gray-700 font-medium italic">...</p>
      </div>
     </div>
    </section>
   </main>
  </div>

<script>
    const API_BASE = "http://localhost:5000/api";
    let token = localStorage.getItem("token");
    let currentBatchId = 'latest'; 

    function getHeaders() {
        const t = localStorage.getItem("token");
        const headers = { "Content-Type": "application/json" };
        if (t) headers.Authorization = `Bearer ${t}`;
        return headers;
    }

// --- H√ÄM ƒêI·ªÄU H∆Ø·ªöNG (B·ªä THI·∫æU) ---
    function showSection(id) {
        // ·∫®n t·∫•t c·∫£ c√°c section
        document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
        
        // Hi·ªán section ƒë∆∞·ª£c ch·ªçn
        const el = document.getElementById(id);
        if(el) {
            el.classList.remove('hidden');
        } else {
            console.error(`Kh√¥ng t√¨m th·∫•y section c√≥ id="${id}"`);
        }
    }
// --- H√ÄM ƒêI·ªÄU H∆Ø·ªöNG ---
    function showSection(id) {
        // ·∫®n t·∫•t c·∫£ c√°c section
        document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
        
        // Hi·ªán section ƒë∆∞·ª£c ch·ªçn
        const el = document.getElementById(id);
        if(el) {
            el.classList.remove('hidden');
        } else {
            console.error(`Kh√¥ng t√¨m th·∫•y section c√≥ id="${id}"`);
        }
    }

    // [B·ªî SUNG] H√†m n√†y ƒëang b·ªã thi·∫øu g√¢y ra l·ªói
    function checkDataAndShow(sectionId) {
        showSection(sectionId);
        
        // N·∫øu b·∫•m v√†o H·ªçc t·ª´ th√¨ g·ªçi h√†m kh·ªüi t·∫°o h·ªçc
        if(sectionId === 'learning') {
            initLearning(); // M·∫∑c ƒë·ªãnh load b·ªô m·ªõi nh·∫•t ho·∫∑c b·ªô ƒëang ch·ªçn
        }
        
        // N·∫øu b·∫•m v√†o Game th√¨ g·ªçi h√†m kh·ªüi t·∫°o game
        if(sectionId === 'games') {
            initGames();
        }
    }
    
    // State qu·∫£n l√Ω d·ªØ li·ªáu
    let vocabList = [];
    let vocabIndex = 0;
    let currentTestQuestions = [];
    let currentTestQs = [];
    let aiCamera = null;
    let activeTestIndex = 0;
    let hardWords = new Set();

    async function ensureTestAICamera() {
        const statusEl = document.getElementById('aiStatus');
        const container = document.getElementById('aiCameraContainer');

        if (!aiCamera) {
            aiCamera = new AICamera('aiVideo', (state, emotion, score) => {
                if (state === 'struggling') registerStruggle(emotion, score);
            });
        }

        if (!aiCamera.isRunning) {
            await aiCamera.start();
            if (statusEl) statusEl.innerText = "ON";
            if (container) container.classList.remove('hidden');
        }
    }

    function toggleAICamera() {
        const statusEl = document.getElementById('aiStatus');
        const container = document.getElementById('aiCameraContainer');

        if (!aiCamera) {
            aiCamera = new AICamera('aiVideo', (state, emotion, score) => {
                if (state === 'struggling') registerStruggle(emotion, score);
            });
        }

        if (aiCamera.isRunning) {
            aiCamera.stop();
            if (statusEl) statusEl.innerText = "OFF";
            if (container) container.classList.add('hidden');
        } else {
            aiCamera.start();
            if (statusEl) statusEl.innerText = "ON";
            if (container) container.classList.remove('hidden');
        }
    }

    function setActiveTestIndex(i) {
        activeTestIndex = i;
        if (aiCamera?.resetStruggle) aiCamera.resetStruggle();
    }

    function getHardWordFromQuestion(q) {
        return q?.targetWord || q?.word || q?.correctAnswer || null;
    }

    function registerStruggle(emotion, score) {
        const q = currentTestQs[activeTestIndex];
        const hardWord = getHardWordFromQuestion(q);
        if (!hardWord) return;

        hardWords.add(hardWord);
        const card = document.getElementById(`q-card-${activeTestIndex}`);
        if (card) card.style.border = "2px solid orange";

        console.log(`üìù ƒê√£ ghi l·∫°i t·ª´ kh√≥: ${hardWord} (Do bi·ªÉu hi·ªán ${emotion}, ${score?.toFixed?.(2) ?? score})`);
    }

    async function sendHardWords(reason = "test-submit") {
        if (!hardWords.size) return;

        try {
            const res = await fetch(`${API_BASE}/vocab/hard-words`, {
                method: "POST",
                headers: getHeaders(),
                body: JSON.stringify({
                    batchId: currentBatchId,
                    hardWords: Array.from(hardWords),
                    reason
                })
            });
            if (res.ok) hardWords.clear();
        } catch (e) {
            console.error("L·ªói g·ª≠i hardWords:", e);
        }
    }

    // --- MAIN FLOW (LU·ªíNG CH√çNH) ---
    window.onload = async function() {
        if (!token) { window.location.href = 'trangdangnhap.html'; return; }
        
        try {
            // Ki·ªÉm tra tr·∫°ng th√°i User xem ƒëang ·ªü b∆∞·ªõc n√†o
            const res = await fetch(`${API_BASE}/placement/status`, { headers: getHeaders() });
            const status = await res.json();
            
            if (!status.hasFinishedTest) {
                // 1. Ch∆∞a Test -> V√†o l√†m Placement Test
                showSection('assessment');
            } else if (!status.hasProfile) {
                // 2. Test r·ªìi nh∆∞ng ch∆∞a ƒëi·ªÅn Form -> Hi·ªán Form
                showSection('assessment');
                document.getElementById('assessmentIntro').classList.add('hidden');
                document.getElementById('assessmentResult').classList.remove('hidden');
                document.getElementById('preferenceForm').classList.remove('hidden');
                if(status.level) document.getElementById('finalLevel').innerText = status.level;
            } else {
                // 3. Xong h·∫øt -> V√†o Menu ch√≠nh
                showSection('menu');
                loadBatches(); // Load danh s√°ch c√°c b·ªô t·ª´ ƒë√£ h·ªçc
            }
        } catch(e) { console.error("L·ªói t·∫£i tr·∫°ng th√°i:", e); }
    };

    // --- 1. PLACEMENT TEST (30 C√ÇU) ---
    let assessmentId = null;
    async function startPlacement() {
        document.getElementById('assessmentIntro').classList.add('hidden');
        document.getElementById('assessmentQuiz').classList.remove('hidden');
        
        const res = await fetch(`${API_BASE}/placement/start`, { method: "POST", headers: getHeaders() });
        const data = await res.json();
        assessmentId = data.assessmentId;
        renderQuestion(data.question);
    }

    function renderQuestion(q) {
        document.getElementById('assessmentQuestion').innerHTML = `
            <h3 class="text-xl font-bold mb-6 text-gray-800">${q.content}</h3>
            <div class="grid gap-3">
                ${q.options.map(opt => `
                    <button onclick="submitAns('${opt}')" 
                    class="p-4 border-2 border-gray-100 rounded-xl hover:border-pink-500 hover:bg-pink-50 text-left transition-all font-medium text-gray-700">
                    ${opt}
                    </button>
                `).join('')}
            </div>
        `;
        document.getElementById('assessmentScore').innerText = `C√¢u ${q.current}/${q.total}`;
        document.getElementById('assessmentProgress').style.width = `${(q.current/q.total)*100}%`;
    }

    async function submitAns(ans) {
        const res = await fetch(`${API_BASE}/placement/next`, { 
            method: "POST", headers: getHeaders(), body: JSON.stringify({ assessmentId, answer: ans }) 
        });
        const data = await res.json();
        
        if (data.done) {
            // Ho√†n th√†nh Test -> Hi·ªán k·∫øt qu·∫£ & Form
            document.getElementById('assessmentQuiz').classList.add('hidden');
            document.getElementById('assessmentResult').classList.remove('hidden');
            document.getElementById('finalLevel').innerText = data.finalLevel;
            document.getElementById('preferenceForm').classList.remove('hidden');
        } else {
            renderQuestion(data.question);
        }
    }

    // --- 2. ONBOARDING (FORM -> T·∫†O BATCH 1) ---
    async function submitPreferences() {
        // S·ª¨A D√íNG N√ÄY: G·ªçi ƒë√∫ng ID c·ªßa n√∫t v·ª´a ƒë·∫∑t
        const btn = document.getElementById('btnGenerate'); 
        
        // Th√™m ki·ªÉm tra ƒë·ªÉ tr√°nh l·ªói n·∫øu kh√¥ng t√¨m th·∫•y n√∫t
        if (btn) {
            btn.innerText = "‚è≥ AI ƒëang t·∫°o l·ªô tr√¨nh & t·ª´ v·ª±ng...";
            btn.disabled = true;
        }

        // L·∫•y d·ªØ li·ªáu t·ª´ Form
        const topicSelect = document.getElementById('topicSelect');
        const interests = topicSelect ? Array.from(topicSelect.selectedOptions).map(o => o.value) : ["General"];
        
        const goalInput = document.querySelector('input[name="goal"]:checked');
        const goal = goalInput ? goalInput.value : "Communication";
        
        try {
            const res = await fetch(`${API_BASE}/onboarding/survey`, {
                method: "POST", headers: getHeaders(),
                body: JSON.stringify({ interests: [interests[0] || "General"], goal })
            });
            
            const data = await res.json();

            if(res.ok) {
                alert(`Th√†nh c√¥ng! ƒê√£ t·∫°o b·ªô t·ª´ v·ª±ng m·ªõi (${data.count} t·ª´).`);
                window.location.reload(); // Reload ƒë·ªÉ v√†o th·∫≥ng Menu
            } else {
                alert("L·ªói: " + (data.message || "Kh√¥ng th·ªÉ l∆∞u form"));
                if(btn) btn.disabled = false;
            }
        } catch(e) { 
            console.error(e);
            alert("L·ªói k·∫øt n·ªëi t·ªõi Server."); 
            if(btn) btn.disabled = false; 
        }
    }

    // --- 3. H·ªåC T·ª™ V·ª∞NG (LEARNING) ---
    // 1. C·∫≠p nh·∫≠t h√†m loadBatches (ƒê·ªÉ n√≥ hi·ªán danh s√°ch v√†o menu)
    async function loadBatches() {
        try {
            const res = await fetch(`${API_BASE}/vocab/batches`, { headers: getHeaders() });
            const batches = await res.json();
            
            const select = document.getElementById('batchSelect');
            if(select && batches.length > 0) {
                // Render danh s√°ch b·ªô t·ª´ v√†o th·∫ª select
                select.innerHTML = `<option value="latest">‚≠ê B·ªô t·ª´ m·ªõi nh·∫•t</option>` + 
                    batches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
                
                // Gi·ªØ tr·∫°ng th√°i b·ªô ƒëang ch·ªçn
                if(currentBatchId) select.value = currentBatchId;
            }
        } catch(e) { console.error("L·ªói load batches:", e); }
    }

    // 2. Th√™m h√†m changeBatch (H√†m b·ªã thi·∫øu g√¢y ra l·ªói)
    function changeBatch() {
        const select = document.getElementById('batchSelect');
        if(select) {
            // L·∫•y ID b·ªô t·ª´ v·ª´a ch·ªçn v√† g·ªçi h√†m h·ªçc l·∫°i
            initLearning(select.value);
        }
    }

async function initLearning(batchId = 'latest') {
    currentBatchId = batchId;
    showSection('learning');
    
    // Reset giao di·ªán flashcard
    document.getElementById('flashcard').classList.remove('hidden', 'flipped');
    
    try {
        // T·∫£i danh s√°ch b·ªô t·ª´ n·∫øu ch∆∞a c√≥ (ƒë·ªÉ menu ho·∫°t ƒë·ªông)
        const select = document.getElementById('batchSelect');
        if (select && select.options.length <= 2) await loadBatches();

        const res = await fetch(`${API_BASE}/vocab/learning?batchId=${currentBatchId}`, { headers: getHeaders() });
        vocabList = await res.json();
        
        if (!vocabList || vocabList.length === 0) {
            alert("B·ªô t·ª´ n√†y ch∆∞a c√≥ t·ª´ n√†o. H√£y t·∫°o b·ªô m·ªõi!");
            return;
        }
        vocabIndex = 0;
        updateFlashcard();
    } catch (error) { console.error(error); }
}
function updateFlashcard() {
    if (!vocabList[vocabIndex]) return;
    const item = vocabList[vocabIndex];
    
    document.getElementById('wordFront').innerText = item.word;
    document.getElementById('wordBack').innerText = item.meaning;

    // FIX: ∆Øu ti√™n l·∫•y example t·ª´ backend tr·∫£ v·ªÅ
    const exDisplay = document.getElementById('wordExample');
    if (exDisplay) {
        let ex = item.example || item.sentence || item.context;
        if (ex && ex.trim() !== "") {
            exDisplay.innerText = `"${ex}"`;
            exDisplay.classList.remove("text-gray-400");
        } else {
            exDisplay.innerText = "(Ch∆∞a c√≥ v√≠ d·ª•)";
            exDisplay.classList.add("text-gray-400");
        }
    }
    
    // Update ti·∫øn ƒë·ªô
    document.getElementById('learningCurrent').innerText = vocabIndex + 1;
    document.getElementById('learningTotal').innerText = vocabList.length;
    document.getElementById('learningProgress').style.width = `${((vocabIndex+1)/vocabList.length)*100}%`;
    document.getElementById('flashcard').classList.remove('flipped');
}
// --- C√ÅC H√ÄM ƒêI·ªÄU KHI·ªÇN FLASHCARD (B·ªä THI·∫æU) ---
    function flipCard() {
        document.getElementById('flashcard').classList.toggle('flipped');
    }

    function nextWord() {
        if (vocabIndex < vocabList.length - 1) {
            vocabIndex++;
            updateFlashcard();
        } else {
            alert("B·∫°n ƒë√£ h·ªçc h·∫øt danh s√°ch n√†y!");
        }
    }

    function previousWord() {
        if (vocabIndex > 0) {
            vocabIndex--;
            updateFlashcard();
        }
    }
// --- H√ÄM PH√ÅT √ÇM (TEXT TO SPEECH) ---
    function playAudio(event) {
        // 1. NgƒÉn kh√¥ng cho l·∫≠t th·∫ª khi b·∫•m v√†o loa
        event.stopPropagation(); 

        // 2. L·∫•y t·ª´ hi·ªán t·∫°i
        if (!vocabList[vocabIndex]) return;
        const textToRead = vocabList[vocabIndex].word;

        // 3. G·ªçi API c·ªßa tr√¨nh duy·ªát ƒë·ªÉ ƒë·ªçc
        const utterance = new SpeechSynthesisUtterance(textToRead);
        utterance.lang = 'en-US'; // Gi·ªçng M·ªπ (ho·∫∑c 'en-GB' n·∫øu th√≠ch gi·ªçng Anh)
        utterance.rate = 0.8;     // T·ªëc ƒë·ªô ƒë·ªçc (0.8 l√† v·ª´a ph·∫£i, d·ªÖ nghe)
        utterance.pitch = 1;      // Cao ƒë·ªô b√¨nh th∆∞·ªùng
        
        window.speechSynthesis.speak(utterance);
    }
   async function markAsLearned() {
    const item = vocabList[vocabIndex];
    if (!item) return;

    try {
        // FIX: URL l√† /vocab/master v√† body l√† vocabId
        const res = await fetch(`${API_BASE}/vocab/master`, {
            method: "POST",
            headers: getHeaders(),
            body: JSON.stringify({ vocabId: item.id }) 
        });

        if (res.ok) {
            // C·∫≠p nh·∫≠t s·ªë ƒë·∫øm tr√™n giao di·ªán
            const countEl = document.getElementById('learnedCount');
            if(countEl) {
                let c = parseInt(countEl.innerText.replace(/\D/g,'')) || 0;
                countEl.innerText = `ƒê√£ h·ªçc: ${c + 1}`;
            }
            nextWord(); 
        } else {
            alert("L·ªói server khi l∆∞u t·ª´!");
        }
    } catch (e) { console.error(e); }
}
// --- H√ÄM T·∫†O B·ªò T·ª™ M·ªöI (D√°n ƒëo·∫°n n√†y v√†o cu·ªëi th·∫ª script) ---
    async function generateNewBatch(btn) {
        // H·ªèi x√°c nh·∫≠n
        if(!confirm("ü§ñ AI s·∫Ω t·∫°o th√™m 15 t·ª´ v·ª±ng m·ªõi cho b·∫°n.\nQu√° tr√¨nh n√†y m·∫•t kho·∫£ng 10-20 gi√¢y.\n\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c?")) return;

        const originalText = btn.innerText;
        btn.innerText = "‚è≥ ƒêang t·∫°o...";
        btn.disabled = true;

        try {
            const focusWords = Array.from(hardWords);
            if (focusWords.length) await sendHardWords("new-batch");

            const res = await fetch(`${API_BASE}/vocab/more`, { 
                method: "POST", 
                headers: getHeaders(),
                body: JSON.stringify({ focusWords })
            });
            const data = await res.json();

            if (res.ok) {
                alert(`‚úÖ Th√†nh c√¥ng! ƒê√£ t·∫°o xong b·ªô t·ª´ m·ªõi g·ªìm ${data.count} t·ª´.`);
                
                // T·∫£i l·∫°i danh s√°ch dropdown
                await loadBatches(); 
                
                // T·ª± ƒë·ªông chuy·ªÉn sang b·ªô v·ª´a t·∫°o
                const select = document.getElementById('batchSelect');
                if(select && data.batchId) {
                    select.value = data.batchId; 
                    changeBatch(); 
                }
            } else {
                alert("‚ö†Ô∏è L·ªói: " + (data.message || "Kh√¥ng t·∫°o ƒë∆∞·ª£c b·ªô t·ª´."));
            }
        } catch (e) {
            console.error(e);
            alert("L·ªói k·∫øt n·ªëi t·ªõi Server AI.");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
// --- LOGIC GAME M·ªöI (ƒê√É FIX L·ªñI) ---
    let currentGameData = null;

    async function initGames() {
        showSection('games');
        
        // Reset giao di·ªán: Hi·ªán menu, ·∫©n khu v·ª±c ch∆°i
        document.getElementById('gameMenu').classList.remove('hidden');
        document.getElementById('gamePlayArea').innerHTML = '';
        
        const container = document.getElementById('gamePlayArea');
        container.innerHTML = '<div class="text-center mt-10"><div class="loading-dots text-2xl text-pink-500">ü§ñ AI ƒëang t·∫£i d·ªØ li·ªáu tr√≤ ch∆°i...</div></div>';

        try {
            // G·ªçi API l·∫•y d·ªØ li·ªáu
            const res = await fetch(`${API_BASE}/vocab/game?batchId=${currentBatchId}`, { headers: getHeaders() });
            const data = await res.json();
            currentGameData = data;

            // X√≥a loading sau khi t·∫£i xong
            container.innerHTML = ''; 

            if (!data || (!data.matching && !data.speedMatch)) {
                alert("B·ªô t·ª´ n√†y ch∆∞a ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ ch∆°i game. H√£y h·ªçc th√™m t·ª´ m·ªõi nh√©!");
            }
        } catch (e) {
            console.error(e);
            container.innerHTML = '<div class="text-center mt-10 text-red-500">L·ªói k·∫øt n·ªëi Game Server</div>';
        }
    }

    // Helper: Quay l·∫°i menu game
    function backToGameMenu() {
        document.getElementById('gameMenu').classList.remove('hidden');
        document.getElementById('gamePlayArea').innerHTML = '';
    }

    // 1. GAME MATCHING
    function playMatching() {
        if(!currentGameData?.matching?.length) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu cho game n√†y.");
        
        // ·∫®n menu, hi·ªán game
        document.getElementById('gameMenu').classList.add('hidden');
        
        let cards = [];
        currentGameData.matching.forEach(item => {
            cards.push({ id: item.id, text: item.term, type: 'term' });
            cards.push({ id: item.id, text: item.match, type: 'match' });
        });
        cards.sort(() => 0.5 - Math.random());

        document.getElementById('gamePlayArea').innerHTML = `
            <div class="mb-4 flex justify-between items-center">
                <h3 class="text-xl font-bold text-pink-600">üé¥ N·ªëi t·ª´</h3>
                <button onclick="backToGameMenu()" class="text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">Tho√°t</button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                ${cards.map(c => `
                    <div onclick="handleMatchClick(this, '${c.id}')" 
                         class="bg-white h-24 flex items-center justify-center p-2 text-center border-2 border-gray-200 rounded-xl cursor-pointer hover:border-pink-400 font-semibold shadow-sm select-none transition-all" 
                         data-id="${c.id}">
                        ${c.text}
                    </div>
                `).join('')}
            </div>
        `;
        window.selectedCard = null;
        window.matchedCount = 0;
    }

    window.handleMatchClick = function(el, id) {
        if (el.classList.contains('bg-green-100') || el === window.selectedCard) return;
        el.classList.add('border-pink-500', 'bg-pink-50');

        if (!window.selectedCard) {
            window.selectedCard = el;
        } else {
            const prevEl = window.selectedCard;
            const prevId = prevEl.getAttribute('data-id');

            if (prevId === id) {
                // ƒê√∫ng
                [el, prevEl].forEach(card => {
                    card.className = "bg-green-100 h-24 flex items-center justify-center p-2 text-center border-2 border-green-500 rounded-xl font-bold text-green-700 opacity-50";
                });
                window.matchedCount++;
                if (window.matchedCount === currentGameData.matching.length) {
                    setTimeout(() => alert("üéâ Xu·∫•t s·∫Øc! B·∫°n ƒë√£ ho√†n th√†nh."), 300);
                }
            } else {
                // Sai
                setTimeout(() => {
                    el.classList.remove('border-pink-500', 'bg-pink-50');
                    prevEl.classList.remove('border-pink-500', 'bg-pink-50');
                }, 500);
            }
            window.selectedCard = null;
        }
    }

    // 2. GAME SPEED MATCH
    function playSpeedMatch() {
        const questions = currentGameData?.speedMatch;
        if(!questions?.length) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu cho game n√†y.");

        document.getElementById('gameMenu').classList.add('hidden');
        let qIndex = 0;
        let score = 0;

        function renderQ() {
            if (qIndex >= questions.length) {
                document.getElementById('gamePlayArea').innerHTML = `
                    <div class="text-center mt-10">
                        <h2 class="text-3xl font-bold mb-4 text-gray-800">üèÅ K·∫øt th√∫c!</h2>
                        <p class="text-xl">ƒêi·ªÉm s·ªë: <span class="text-pink-600 font-bold">${score}/${questions.length}</span></p>
                        <button onclick="backToGameMenu()" class="mt-6 btn-pink text-white px-6 py-2 rounded-lg">Quay l·∫°i Menu</button>
                    </div>`;
                return;
            }
            const q = questions[qIndex];
            document.getElementById('gamePlayArea').innerHTML = `
                <div class="max-w-md mx-auto mt-4 p-6 bg-white rounded-2xl shadow-xl text-center border border-blue-100">
                    <div class="flex justify-between text-gray-400 mb-4 text-xs">
                        <span>C√¢u ${qIndex + 1}/${questions.length}</span>
                        <button onclick="backToGameMenu()" class="underline">Tho√°t</button>
                    </div>
                    <h3 class="text-4xl font-extrabold text-gray-800 mb-2">${q.word}</h3>
                    <p class="text-gray-400 mb-6">c√≥ nghƒ©a l√†</p>
                    <div class="text-xl font-bold text-blue-600 mb-10 p-4 bg-blue-50 rounded-xl border border-blue-100">
                        "${q.meaning}"
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="checkSpeed(false)" class="bg-red-100 text-red-600 py-4 rounded-xl font-bold hover:bg-red-200 text-xl">SAI ‚ùå</button>
                        <button onclick="checkSpeed(true)" class="bg-green-100 text-green-600 py-4 rounded-xl font-bold hover:bg-green-200 text-xl">ƒê√öNG ‚úÖ</button>
                    </div>
                </div>`;
        }

        window.checkSpeed = function(userAnswer) {
            const isCorrect = questions[qIndex].isCorrect;
            if (userAnswer === isCorrect) {
                score++;
                alert("‚úÖ Ch√≠nh x√°c!");
            } else {
                alert("‚ùå Sai r·ªìi!");
            }
            qIndex++;
            renderQ();
        }
        renderQ();
    }

    // 3. GAME WORD HUNT
    function playWordHunt() {
        const words = currentGameData?.wordHunt?.words;
        if(!words?.length) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu cho game n√†y.");

        document.getElementById('gameMenu').classList.add('hidden');
        
        // T·∫°o grid gi·∫£ l·∫≠p (trong th·ª±c t·∫ø c·∫ßn thu·∫≠t to√°n x·∫øp ch·ªØ ph·ª©c t·∫°p h∆°n)
        const gridSize = 10;
        const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        let grid = Array(gridSize).fill(null).map(() => Array(gridSize).fill(''));
        
        // ƒê·∫∑t t·ª´ v√†o grid (ngang)
        words.forEach((w, i) => { 
            if(i < gridSize) {
                for(let j=0; j<w.length && j < gridSize; j++) {
                    grid[i][j] = w[j];
                }
            }
        });
        
        // ƒêi·ªÅn k√Ω t·ª± ng·∫´u nhi√™n v√†o ch·ªó tr·ªëng
        for(let r=0; r<gridSize; r++) {
            for(let c=0; c<gridSize; c++) {
                if(grid[r][c] === '') grid[r][c] = letters[Math.floor(Math.random() * letters.length)];
            }
        }

        document.getElementById('gamePlayArea').innerHTML = `
            <div class="max-w-4xl mx-auto p-4 flex flex-col items-center">
                <div class="w-full flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-green-600">üîç T√¨m c√°c t·ª´ sau:</h2>
                    <button onclick="backToGameMenu()" class="text-sm underline text-gray-500">Tho√°t</button>
                </div>
                <div class="flex flex-wrap gap-2 mb-4 justify-center">
                    ${words.map(w => `<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm font-bold">${w}</span>`).join('')}
                </div>
                <div class="grid grid-cols-10 gap-1 bg-gray-100 p-2 rounded-lg select-none shadow-inner">
                    ${grid.flat().map(c => `
                        <div class="w-8 h-8 md:w-10 md:h-10 bg-white flex items-center justify-center font-bold text-gray-700 cursor-pointer hover:bg-green-200 rounded" 
                             onclick="this.classList.toggle('bg-green-500'); this.classList.toggle('text-white')">
                            ${c}
                        </div>
                    `).join('')}
                </div>
            </div>`;
    }
// ==========================================
// --- LOGIC KI·ªÇM TRA (TEST SECTION) ---

    async function initTestSection() {
        showSection('test');
        hardWords.clear();
        activeTestIndex = 0;
        if (aiCamera?.resetStruggle) aiCamera.resetStruggle();
        await ensureTestAICamera();
        
        // Reset giao di·ªán v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
        document.getElementById('testLoading').classList.remove('hidden');
        document.getElementById('testQuiz').classList.add('hidden');
        document.getElementById('testResult').classList.add('hidden');
        document.getElementById('testSubmit').classList.remove('hidden');
        document.getElementById('testRetry').classList.add('hidden');
        document.getElementById('testScoreDisplay').classList.add('hidden');
        
        try {
            // G·ªçi API l·∫•y c√¢u h·ªèi
            const res = await fetch(`${API_BASE}/vocab/test?batchId=${currentBatchId}`, { headers: getHeaders() });
            const data = await res.json();
            
            document.getElementById('testLoading').classList.add('hidden');

            if (data.questions && data.questions.length > 0) {
                currentTestQs = data.questions;
                renderTest(); // V·∫Ω c√¢u h·ªèi ra m√†n h√¨nh
                document.getElementById('testQuiz').classList.remove('hidden');
            } else {
                document.getElementById('testQuestions').innerHTML = `
                    <div class="text-center py-10 text-red-500">
                        <p class="text-xl font-bold">‚ö†Ô∏è Ch∆∞a ƒë·ªß d·ªØ li·ªáu</p>
                        <p class="mt-2">B·∫°n c·∫ßn h·ªçc √≠t nh·∫•t 5 t·ª´ v·ª±ng ƒë·ªÉ t·∫°o b√†i ki·ªÉm tra.</p>
                        <button onclick="checkDataAndShow('learning')" class="mt-6 text-pink-600 underline font-bold">ƒêi h·ªçc t·ª´ ngay</button>
                    </div>`;
                document.getElementById('testQuiz').classList.remove('hidden');
                document.getElementById('testSubmit').classList.add('hidden');
            }
        } catch (e) {
            console.error(e);
            document.getElementById('testLoading').classList.add('hidden');
            alert("L·ªói k·∫øt n·ªëi AI server. Vui l√≤ng th·ª≠ l·∫°i sau.");
        }
    }

    function renderTest() {
        const container = document.getElementById('testQuestions');
        container.innerHTML = currentTestQs.map((q, idx) => `
            <div class="question-card bg-gray-50 p-6 rounded-2xl border border-gray-200 transition-all hover:shadow-md" id="q-card-${idx}" onclick="setActiveTestIndex(${idx})">
                <div class="flex items-start gap-3 mb-4">
                    <span class="bg-pink-100 text-pink-600 font-bold px-3 py-1 rounded-lg text-sm whitespace-nowrap">C√¢u ${idx+1}</span>
                    <p class="font-bold text-lg text-gray-800 leading-relaxed pt-1">${q.question}</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="group-${idx}">
                    ${q.options.map(opt => `
                        <label class="option-label flex items-center p-4 border-2 border-white bg-white rounded-xl cursor-pointer hover:border-pink-200 shadow-sm transition-all group">
                            <input type="radio" name="q${idx}" value="${opt}" class="w-5 h-5 text-pink-600 accent-pink-500 mr-3" onchange="setActiveTestIndex(${idx}); updateTestProgress()">
                            <span class="font-medium text-gray-600 group-hover:text-gray-900">${opt}</span>
                        </label>
                    `).join('')}
                </div>

                <div id="explain-${idx}" class="hidden mt-6 pt-6 border-t border-gray-200 animation-fade-in">
                    <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 text-sm">
                        <p class="text-green-700 font-bold text-base mb-2">‚úÖ ƒê√°p √°n ƒë√∫ng: ${q.correctAnswer}</p>
                        <p class="text-gray-700 mb-4"><span class="font-bold">üí° Gi·∫£i th√≠ch:</span> ${q.explanation || "Ch∆∞a c√≥ gi·∫£i th√≠ch chi ti·∫øt."}</p>
                        
                        <div class="bg-white p-3 rounded-lg border border-blue-100">
                            <p class="font-bold text-gray-500 mb-2 text-xs uppercase tracking-wider">T·ª´ v·ª±ng trong c√¢u:</p>
                            <ul class="space-y-1">
                                ${Object.entries(q.meanings || {}).map(([key, val]) => 
                                    `<li class="flex justify-between border-b border-gray-100 pb-1 last:border-0">
                                        <span class="font-semibold text-gray-800">${key}</span>
                                        <span class="text-gray-500">${val}</span>
                                    </li>`
                                ).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('testProgress').style.width = '0%';
        setActiveTestIndex(0);
    }

    function updateTestProgress() {
        const total = currentTestQs.length;
        const answered = document.querySelectorAll('#testQuestions input[type="radio"]:checked').length;
        document.getElementById('testProgress').style.width = `${(answered/total)*100}%`;
    }

    function submitTest() {
        // Ki·ªÉm tra xem ƒë√£ l√†m h·∫øt ch∆∞a
        const answered = document.querySelectorAll('#testQuestions input[type="radio"]:checked').length;
        if (answered < currentTestQs.length) {
            if(!confirm(`B·∫°n m·ªõi l√†m ${answered}/${currentTestQs.length} c√¢u. B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i kh√¥ng?`)) return;
        }

        let score = 0;
        
        currentTestQs.forEach((q, idx) => {
            const selectedInput = document.querySelector(`input[name="q${idx}"]:checked`);
            const userAns = selectedInput ? selectedInput.value : null;
            const explainDiv = document.getElementById(`explain-${idx}`);
            const group = document.getElementById(`group-${idx}`);

            // 1. Kh√≥a kh√¥ng cho ch·ªçn l·∫°i
            group.querySelectorAll('input').forEach(i => i.disabled = true);
            group.querySelectorAll('label').forEach(l => l.classList.add('cursor-default'));

            // 2. Ch·∫•m ƒëi·ªÉm
            let isCorrect = false;
            if (userAns === q.correctAnswer) {
                score++;
                isCorrect = true;
            }

            // 3. T√¥ m√†u ƒë√°p √°n
            group.querySelectorAll('label').forEach(label => {
                const input = label.querySelector('input');
                const val = input.value;

                // Reset style c≈©
                label.classList.remove('bg-white', 'border-white', 'hover:border-pink-200');

                if (val === q.correctAnswer) {
                    // ƒê√°p √°n ƒê√öNG -> Xanh l√°
                    label.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                    label.innerHTML += ' <span class="ml-auto text-xl font-bold">‚úÖ</span>';
                } else if (val === userAns && !isCorrect) {
                    // ƒê√°p √°n SAI ng∆∞·ªùi d√πng ch·ªçn -> ƒê·ªè
                    label.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                    label.innerHTML += ' <span class="ml-auto text-xl font-bold">‚ùå</span>';
                } else {
                    // C√°c ƒë√°p √°n c√≤n l·∫°i -> M·ªù ƒëi
                    label.classList.add('bg-gray-50', 'border-transparent', 'opacity-50');
                }
            });

            // 4. Hi·ªán gi·∫£i th√≠ch
            explainDiv.classList.remove('hidden');
        });

        // 5. Hi·ªÉn th·ªã k·∫øt qu·∫£ t·ªïng
        document.getElementById('testSubmit').classList.add('hidden');
        document.getElementById('testRetry').classList.remove('hidden');
        document.getElementById('testResult').classList.remove('hidden');
        document.getElementById('testScoreDisplay').classList.remove('hidden');
        
        document.getElementById('testFinalScore').innerText = score;
        document.getElementById('testScoreDisplay').innerText = `ƒêi·ªÉm: ${score}/${currentTestQs.length}`;

        // Feedback
        const percent = (score / currentTestQs.length);
        const fb = document.getElementById('testFeedback');
        if (percent === 1) fb.innerText = "üåü Xu·∫•t s·∫Øc! B·∫°n ƒë√£ l√†m ch·ªß ho√†n to√†n c√°c t·ª´ v·ª±ng n√†y.";
        else if (percent >= 0.8) fb.innerText = "üî• R·∫•t t·ªët! Ch·ªâ c√≤n m·ªôt v√†i l·ªói nh·ªè th√¥i.";
        else if (percent >= 0.5) fb.innerText = "üëç Kh√° ·ªïn! H√£y xem k·ªπ ph·∫ßn gi·∫£i th√≠ch c√°c c√¢u sai nh√©.";
        else fb.innerText = "üí™ C·∫ßn c·ªë g·∫Øng h∆°n! H√£y √¥n t·∫≠p l·∫°i b·ªô t·ª´ v·ª±ng n√†y.";

        // Cu·ªôn m√†n h√¨nh ƒë·∫øn ph·∫ßn k·∫øt qu·∫£
        document.getElementById('testResult').scrollIntoView({ behavior: 'smooth', block: 'center' });
        sendHardWords("test-submit");
    }
</script>
<div id="aiCameraContainer" class="fixed bottom-4 right-4 z-50 hidden transition-all">
    <div class="relative w-32 h-24 border-2 border-blue-400 rounded-xl overflow-hidden shadow-lg bg-black">
        <video id="aiVideo" width="320" height="240" autoplay muted playsinline class="w-full h-full object-cover transform scale-x-[-1]"></video>
        <div class="absolute top-0 right-0 bg-blue-500 text-white text-[10px] px-1">AI ON</div>
    </div>
</div>

<script src="/_sdk/face-api.min.js"></script> <script src="/_sdk/ai_camera.js"></script>
 </body>
</html>